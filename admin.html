<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | كويز الرمضاني</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f3f4f6; }
        .sidebar { min-height: 100vh; background-color: #1e293b; transition: 0.3s; z-index: 50; }
        @media (max-width: 768px) { .sidebar { position: fixed; right: 0; transform: translateX(100%); } .sidebar.open { transform: translateX(0); } }
        .nav-item.active { background-color: #3b82f6; color: white; }
        .section-content { display: none; }
        .section-content.active { display: block; }
    </style>
</head>
<body class="flex">

    <div class="md:hidden bg-gray-900 text-white p-4 flex justify-between items-center fixed w-full top-0 z-40">
        <h1 class="font-bold">المدير العام</h1>
        <button onclick="toggleSidebar()" class="text-yellow-500 text-2xl"><i class="fas fa-bars"></i></button>
    </div>

    <aside id="sidebar" class="sidebar w-64 text-gray-300 flex flex-col fixed h-full md:right-0">
        <div class="p-6 text-center border-b border-gray-700">
            <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-16 h-16 mx-auto rounded-full mb-3 border-2 border-yellow-500">
            <h2 class="text-sm font-bold">لوحة التحكم</h2>
        </div>
        <nav class="mt-6 flex-1">
            <div class="nav-item active p-4 cursor-pointer flex items-center gap-3" onclick="switchTab('settings')"><i class="fas fa-cog"></i> الإعدادات</div>
            <div class="nav-item p-4 cursor-pointer flex items-center gap-3" onclick="switchTab('users')"><i class="fas fa-users"></i> المشتركين</div>
            <div class="nav-item p-4 cursor-pointer flex items-center gap-3" onclick="switchTab('quizzes')"><i class="fas fa-futbol"></i> بنك الكويزات</div>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 md:mr-64 mt-16 md:mt-0">
        
        <section id="settings" class="section-content active">
            <h2 class="text-2xl font-bold mb-6">الإعدادات</h2>
            <div class="bg-white p-6 rounded shadow-md">
                <label class="block mb-2 font-bold">آية / دعاء اليوم</label>
                <textarea id="daily-msg" class="w-full p-2 border rounded mb-4" rows="3"></textarea>
                <button id="save-msg-btn" class="bg-blue-600 text-white px-6 py-2 rounded">نشر الرسالة</button>
            </div>
        </section>

        <section id="users" class="section-content">
            <h2 class="text-2xl font-bold mb-6">إدارة المشتركين</h2>
            <div class="bg-white p-4 rounded shadow mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <input type="text" id="u-name" placeholder="الاسم" class="p-2 border rounded">
                    <input type="text" id="u-pass" placeholder="الكود" class="p-2 border rounded">
                    <select id="u-group" class="p-2 border rounded">
                        <option value="المجموعة 1">المجموعة 1</option>
                        <option value="المجموعة 2">المجموعة 2</option>
                    </select>
                    <button id="add-user-btn" class="bg-green-600 text-white rounded">إضافة</button>
                </div>
            </div>
            <div class="bg-white rounded shadow overflow-x-auto">
                <table class="w-full text-right">
                    <thead class="bg-gray-100"><tr><th class="p-3">الاسم</th><th class="p-3">المجموعة</th><th class="p-3">النقاط</th><th class="p-3">إجراء</th></tr></thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="quizzes" class="section-content">
            <h2 class="text-2xl font-bold mb-4">إضافة كويز (15 سؤال)</h2>
            <input type="text" id="quiz-title" placeholder="عنوان الكويز" class="w-full p-2 border rounded mb-4">
            <div id="q-container" class="space-y-4"></div>
            <button id="save-quiz-btn" class="w-full bg-blue-700 text-white p-4 rounded mt-6 font-bold">حفظ الكويز</button>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, addDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8",
            projectId: "ramadan-87817",
            appId: "1:343525703258:web:6776b4857425df8bcca263"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        window.switchTab = (id) => {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'users') loadUsers();
            if(window.innerWidth < 768) toggleSidebar();
        };

        document.getElementById('save-msg-btn').onclick = async () => {
            await setDoc(doc(db, "settings", "dailyData"), { message: document.getElementById('daily-msg').value });
            alert("تم!");
        };

        document.getElementById('add-user-btn').onclick = async () => {
            await addDoc(collection(db, "users"), {
                name: document.getElementById('u-name').value,
                password: document.getElementById('u-pass').value,
                group: document.getElementById('u-group').value,
                score: 0, rounds: 0, isQuizActive: false, hasCompletedToday: false
            });
            loadUsers();
        };

        window.loadUsers = async () => {
            const snap = await getDocs(collection(db, "users"));
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                tbody.innerHTML += `<tr class="border-b"><td class="p-3">${data.name}</td><td class="p-3">${data.group}</td><td class="p-3">${data.score}</td>
                <td class="p-3"><button onclick="toggleActive('${d.id}', ${!data.isQuizActive})" class="p-1 rounded ${data.isQuizActive?'bg-red-400':'bg-green-400'} text-xs">${data.isQuizActive?'قفل':'فتح'}</button></td></tr>`;
            });
        };

        window.toggleActive = async (id, status) => {
            await updateDoc(doc(db, "users", id), { isQuizActive: status });
            loadUsers();
        };

        const qc = document.getElementById('q-container');
        for(let i=1; i<=15; i++){
            qc.innerHTML += `<div class="p-3 bg-white border rounded shadow-sm">
                <p class="font-bold text-xs">سؤال ${i}</p>
                <input type="text" placeholder="السؤال" class="q-t w-full p-1 border rounded mb-1 text-sm">
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <input type="text" placeholder="1" class="o1 p-1 border rounded text-xs">
                    <input type="text" placeholder="2" class="o2 p-1 border rounded text-xs">
                    <input type="text" placeholder="3" class="o3 p-1 border rounded text-xs">
                    <input type="text" placeholder="4" class="o4 p-1 border rounded text-xs">
                </div>
                <select class="cor w-full p-1 border rounded text-xs"><option value="0">الإجابة 1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option></select>
            </div>`;
        }

        document.getElementById('save-quiz-btn').onclick = async () => {
            const qs = [];
            document.querySelectorAll('#q-container > div').forEach(div => {
                qs.push({
                    q: div.querySelector('.q-t').value,
                    options: [div.querySelector('.o1').value, div.querySelector('.o2').value, div.querySelector('.o3').value, div.querySelector('.o4').value],
                    correctIndex: parseInt(div.querySelector('.cor').value)
                });
            });
            await addDoc(collection(db, "quizzes"), { title: document.getElementById('quiz-title').value, questions: qs });
            alert("تم حفظ الكويز!");
        };
    </script>
</body>
</html>
