<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <title>الإدارة المركزية | كويز الرمضاني</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #030712; color: #f3f4f6; margin: 0; padding: 0; overflow-x: hidden; }
        .nav-btn { flex-shrink: 0; padding: 12px 15px; border-radius: 12px; font-weight: bold; cursor: pointer; color: #94a3b8; background: #1e293b; transition: 0.3s; }
        .nav-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: white; }
        .day-pill { flex-shrink: 0; padding: 8px 20px; background: #1e293b; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .day-pill.active { background: #b8860b; color: white; }
        .days-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 10px; }
    </style>
</head>
<body>

    <header class="bg-gray-900 border-b border-gray-800 p-4 sticky top-0 z-40 shadow-2xl">
        <div class="text-center mb-4">
            <h2 class="font-bold text-yellow-500 text-2xl">الإدارة المركزية <span class="text-white text-xs bg-blue-600 px-2 py-1 rounded-full ml-1">v7.2 Ultimate</span></h2>
        </div>
        <div class="flex gap-2 overflow-x-auto pb-2">
            <button id="nav-users" class="nav-btn active">اللاعبين</button>
            <button id="nav-groups" class="nav-btn">المجموعات</button>
            <button id="nav-quizzes" class="nav-btn">الكويزات</button>
            <button id="nav-tournament" class="nav-btn">البطولة</button>
        </div>
    </header>

    <div id="sys-status" class="bg-yellow-600 text-white text-center py-1 text-xs font-bold">جاري تشغيل محرك البيانات...</div>

    <main class="p-4 max-w-7xl mx-auto pb-32">
        <div id="tab-users" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold">المشتركين</h1>
                <button id="btn-reset-users" class="bg-red-600 px-4 py-2 rounded-xl font-bold text-sm">يوم جديد</button>
            </div>
            <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800 mb-6 shadow-xl">
                <div class="grid grid-cols-1 gap-4">
                    <input type="text" id="u-name" placeholder="الاسم" class="p-3 bg-gray-800 rounded-xl outline-none border border-gray-700">
                    <input type="text" id="u-pass" placeholder="الكود السري" class="p-3 bg-gray-800 rounded-xl outline-none border border-gray-700 text-yellow-500 font-bold">
                    <select id="u-group" class="p-3 bg-gray-800 rounded-xl border border-gray-700 text-white font-bold"><option value="">بانتظار المجموعات...</option></select>
                    <select id="u-role" class="p-3 bg-gray-800 rounded-xl border border-gray-700 text-white font-bold"><option value="user">متسابق عادي</option><option value="tester">حساب إشراف</option></select>
                    <button id="btn-add-user" class="bg-green-600 py-4 rounded-xl font-bold text-lg shadow-lg">حفظ وإضافة الآن</button>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-right text-sm whitespace-nowrap min-w-max"><thead class="bg-gray-800 text-gray-400"><tr><th class="p-4">الاسم</th><th class="p-4">النوع</th><th class="p-4">المجموعة</th><th class="p-4">النقاط</th><th class="p-4">حذف</th></tr></thead><tbody id="users-table-body"></tbody></table></div>
        </div>

        <div id="tab-groups" class="tab-content hidden">
            <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 mb-6 shadow-xl">
                <label class="block text-yellow-500 font-bold mb-4">أضف مجموعة جديدة</label>
                <input type="text" id="new-group-name" placeholder="اسم المجموعة" class="w-full p-4 bg-gray-800 rounded-xl outline-none mb-4">
                <button id="btn-add-group" class="w-full bg-blue-600 py-4 rounded-xl font-bold">إضافة للقائمة</button>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="tab-quizzes" class="tab-content hidden">
            <div class="days-scroll bg-gray-900 rounded-xl mb-6 shadow-inner" id="days-strip"></div>
            <button id="btn-open-quiz-modal" class="w-full bg-yellow-600 py-4 rounded-xl font-bold mb-6">إضافة كويز لليوم <span id="selected-day-title">1</span></button>
            <div id="quizzes-list" class="grid grid-cols-1 gap-4"></div>
        </div>
    </main>

    <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-95 overflow-y-auto hidden z-50">
        <div class="p-4 max-w-4xl mx-auto py-10">
            <button id="btn-close-modal" class="fixed top-4 left-4 bg-red-600 w-12 h-12 rounded-full text-white font-bold z-50">X</button>
            <h3 class="text-yellow-500 text-center text-xl mb-6" id="modal-title">إضافة كويز</h3>
            <input type="text" id="q-title" class="w-full p-4 bg-gray-800 rounded-xl mb-6" placeholder="عنوان الكويز">
            <div id="questions-builder" class="space-y-6 mb-8"></div>
            <button id="btn-save-quiz" class="w-full bg-green-600 py-4 rounded-xl font-bold">حفظ الكويز</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, deleteDoc, updateDoc, initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        
        // تعديل وضع الاتصال ليكون (إجباري) ولا ينتظر
        const app = initializeApp(firebaseConfig);
        const db = initializeFirestore(app, { localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }) });

        let activeDay = 1, editingQuizId = null, systemGroups = [];

        const status = document.getElementById('sys-status');
        const showStatus = (msg, color) => { status.innerText = msg; status.className = `text-white text-center py-1 text-xs font-bold ${color}`; };

        // ربط أزرار التنقل
        const setupNav = () => {
            const tabs = ['users', 'groups', 'quizzes', 'tournament'];
            tabs.forEach(tab => {
                const el = document.getElementById(`nav-${tab}`);
                if (el) el.onclick = () => {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.getElementById(`tab-${tab}`)?.classList.remove('hidden');
                    el.classList.add('active');
                    if(tab === 'users') loadUsers();
                    if(tab === 'groups') loadGroups();
                    if(tab === 'quizzes') loadQuizzes();
                };
            });
        };

        async function loadGroups() {
            try {
                const snap = await getDoc(doc(db, "settings", "groupsData"));
                systemGroups = snap.exists() ? snap.data().list : ["المجموعة 1"];
                const select = document.getElementById('u-group');
                select.innerHTML = systemGroups.map(g => `<option value="${g}">${g}</option>`).join('');
                
                const container = document.getElementById('groups-list-container');
                if(container) {
                    container.innerHTML = systemGroups.map((g, i) => `
                        <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center border border-gray-700">
                            <span class="font-bold">${g}</span>
                            <button class="text-red-500 delete-group-btn" data-index="${i}"><i class="fas fa-trash"></i></button>
                        </div>
                    `).join('');
                    document.querySelectorAll('.delete-group-btn').forEach(btn => {
                        btn.onclick = async () => {
                            const idx = btn.getAttribute('data-index');
                            systemGroups.splice(idx, 1);
                            await setDoc(doc(db, "settings", "groupsData"), { list: systemGroups });
                            loadGroups();
                        };
                    });
                }
                showStatus("تم تحديث البيانات بنجاح ✅", "bg-green-600");
            } catch(e) { showStatus("خطأ في الاتصال بالقاعدة ❌", "bg-red-600"); }
        }

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">جاري التحميل...</td></tr>';
            const snap = await getDocs(collection(db, "users"));
            tbody.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-800";
                tr.innerHTML = `<td class="p-4 font-bold">${data.name}</td><td class="p-4">${data.role=='tester'?'إشراف':'لاعب'}</td><td class="p-4 text-blue-400">${data.group}</td><td class="p-4 text-yellow-500">${data.score}</td><td class="p-4"><button class="text-red-500 del-u" data-id="${d.id}"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.del-u').forEach(btn => {
                btn.onclick = async () => { if(confirm("حذف؟")) { await deleteDoc(doc(db, "users", btn.getAttribute('data-id'))); loadUsers(); } };
            });
        }

        // ربط أزرار الإضافة (حدث مباشر)
        document.getElementById('btn-add-user').onclick = async function() {
            const name = document.getElementById('u-name').value, pass = document.getElementById('u-pass').value, group = document.getElementById('u-group').value;
            if(!name || !pass || !group) return alert("املأ البيانات!");
            this.disabled = true; this.innerText = "جاري الحفظ...";
            try {
                await addDoc(collection(db, "users"), { name, password: pass, group, role: document.getElementById('u-role').value, score: 0, rounds: 0, hasCompletedToday: false });
                alert("تمت الإضافة!"); loadUsers();
            } finally { this.disabled = false; this.innerText = "حفظ وإضافة الآن"; }
        };

        document.getElementById('btn-add-group').onclick = async function() {
            const val = document.getElementById('new-group-name').value;
            if(!val) return;
            systemGroups.push(val);
            await setDoc(doc(db, "settings", "groupsData"), { list: systemGroups });
            loadGroups();
        };

        // بناء الأيام
        const strip = document.getElementById('days-strip');
        for(let i=1; i<=30; i++) {
            const p = document.createElement('div'); p.className = `day-pill ${i==1?'active':''}`; p.innerText = `يوم ${i}`;
            p.onclick = () => { document.querySelectorAll('.day-pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); activeDay=i; document.getElementById('selected-day-title').innerText=i; };
            strip.appendChild(p);
        }

        // بناء الـ 15 سؤال
        const qb = document.getElementById('questions-builder');
        for(let i=1; i<=15; i++) {
            qb.innerHTML += `<div class="bg-gray-800 p-4 rounded-xl border border-gray-700 q-block"><span class="text-yellow-500 font-bold">سؤال ${i}</span><textarea class="q-txt w-full bg-gray-900 p-3 rounded-xl mt-2 mb-2"></textarea><input type="text" class="q-img w-full bg-gray-900 p-3 rounded-xl mb-4" placeholder="رابط صورة (اختياري)"><div class="grid grid-cols-2 gap-2"><input type="text" class="o1 bg-gray-900 p-2 rounded-lg" placeholder="1"><input type="text" class="o2 bg-gray-900 p-2 rounded-lg" placeholder="2"><input type="text" class="o3 bg-gray-900 p-2 rounded-lg" placeholder="3"><input type="text" class="o4 bg-gray-900 p-2 rounded-lg" placeholder="4"></div><select class="cor w-full bg-gray-900 p-3 mt-4 rounded-xl text-yellow-500"><option value="0">1 صح</option><option value="1">2 صح</option><option value="2">3 صح</option><option value="3">4 صح</option></select></div>`;
        }

        document.getElementById('btn-open-quiz-modal').onclick = () => { editingQuizId=null; document.getElementById('quiz-modal').classList.remove('hidden'); };
        document.getElementById('btn-close-modal').onclick = () => document.getElementById('quiz-modal').classList.add('hidden');

        setupNav();
        loadGroups().then(() => loadUsers());
    </script>
</body>
</html>
