<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙƒÙˆÙŠØ² Ø§Ù„Ø±Ù…Ø¶Ø§Ù†ÙŠ | Ø§Ù„Ù…Ù„Ø¹Ø¨</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { background-color: #050a15; color: white; font-family: 'Cairo', sans-serif; background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); overflow-x: hidden; }
        .ramadan-card { background: rgba(13, 27, 42, 0.95); border: 1px solid #b8860b; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .tab-btn { transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: #000; font-weight: 900; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        .option-btn { background: #112240; border: 1px solid #233f78; transition: all 0.2s; }
        .option-btn:active { transform: scale(0.95); background: #b8860b; color: black; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 pb-20">

    <div class="flex justify-center mb-4 mt-2">
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-24 h-24 object-contain rounded-full border-2 border-yellow-600 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="ramadan-card flex justify-between items-center p-4 rounded-2xl mb-6 w-full max-w-lg mx-auto">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-2xl text-black"></i>
            </div>
            <div>
                <h2 id="player-name" class="font-bold text-white text-md">---</h2>
                <p id="player-group" class="text-xs text-yellow-500 font-bold">---</p>
            </div>
        </div>
        <div class="text-center bg-gray-900 p-2 rounded-xl border border-gray-700 min-w-[70px]">
            <p class="text-[10px] text-gray-400">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
            <p id="player-score" class="font-black text-xl text-yellow-500">0</p>
        </div>
    </header>

    <div class="flex bg-gray-900 rounded-xl p-1 mb-6 max-w-lg mx-auto w-full border border-gray-800">
        <button onclick="switchTab('arena')" id="btn-arena" class="tab-btn active flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-futbol"></i> Ø§Ù„Ù…Ù„Ø¹Ø¨</button>
        <button onclick="switchTab('leaderboard')" id="btn-leaderboard" class="tab-btn flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-trophy"></i> Ù…Ø¬Ù…ÙˆØ¹ØªÙŠ</button>
    </div>

    <main id="tab-arena" class="tab-content active flex-grow flex flex-col items-center w-full max-w-lg mx-auto">
        <div id="quiz-container" class="w-full">
            <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø¹Ø¨...</p></div>
        </div>
    </main>

    <main id="tab-leaderboard" class="tab-content flex-grow w-full max-w-lg mx-auto">
        <div class="ramadan-card p-5 rounded-2xl">
            <h3 class="text-yellow-500 font-bold mb-4 text-center border-b border-gray-700 pb-2">ÙØ±Ø³Ø§Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
            <div id="group-list" class="space-y-2"><p class="text-center text-gray-400 py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </main>

    <div class="mt-auto pt-8 flex flex-col items-center gap-4">
        <button id="logout-btn" onclick="logout()" class="text-gray-600 text-xs font-bold hover:text-red-500"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        try {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.id) throw new Error("No user");
        } catch(e) { window.location.href = "index.html"; }

        document.getElementById('player-name').innerText = currentUser.name;
        document.getElementById('player-group').innerText = currentUser.group;
        document.getElementById('player-score').innerText = currentUser.score || 0;

        let quizData = []; let currentQuestion = 0; let tempScore = 0; let detailedResults = []; let activeDayNum = 0;
        let timerInterval; let timeLeft = 30; let isQuizActive = false; 

        function switchTab(tabName) {
            if (isQuizActive) { alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ†Ù‚Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!"); return; }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            if(tabName === 'leaderboard') loadGroupLeaderboard();
        }

        async function loadGroupLeaderboard() {
            const listDiv = document.getElementById('group-list');
            try {
                const snap = await db.collection("users").where("group", "==", currentUser.group).get();
                let members = []; snap.forEach(d => members.push(d.data()));
                members.sort((a,b) => (b.score || 0) - (a.score || 0));
                
                listDiv.innerHTML = '';
                members.forEach((m, index) => {
                    let rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-700' : 'text-gray-500';
                    let isMe = m.name === currentUser.name ? 'border-2 border-yellow-600 bg-gray-800 transform scale-105 my-2' : 'bg-gray-900 border border-gray-800';
                    listDiv.innerHTML += `<div class="flex justify-between items-center p-4 rounded-xl transition ${isMe}"><div class="flex items-center gap-4"><span class="font-black text-lg ${rankColor}">${index + 1}</span><span class="font-bold text-sm ${m.name === currentUser.name ? 'text-white' : 'text-gray-300'}">${m.name}</span></div><span class="font-black text-yellow-500 text-lg">${m.score || 0}</span></div>`;
                });
            } catch(e) { listDiv.innerHTML = '<p class="text-center text-red-500 text-xs">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</p>'; }
        }

        db.collection("settings").doc("global_status").onSnapshot(async (docSnap) => {
            const container = document.getElementById('quiz-container');
            if (!docSnap.exists) return;
            
            const globalData = docSnap.data();
            const status = globalData.status;
            activeDayNum = globalData.currentDay;
            const expiryTime = globalData.expiryTime;

            const userSnap = await db.collection("users").doc(currentUser.id).get();
            if(userSnap.exists) {
                currentUser = { id: userSnap.id, ...userSnap.data() };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score || 0;
            }

            if (expiryTime && Date.now() > expiryTime) {
                if(isQuizActive) { isQuizActive = false; clearInterval(timerInterval); endQuiz(); return; }
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><i class="fas fa-hourglass-end text-6xl text-red-500 mb-6 animate-pulse"></i><h2 class="text-2xl font-black text-white mb-2">Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©!</h2></div>`;
                return;
            }

            if (status === 'closed') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><i class="fas fa-lock text-5xl text-red-400 mb-4"></i><h2 class="text-xl font-bold text-white mb-2">Ø§Ù„ØºØ±ÙØ© Ù…ØºÙ„Ù‚Ø©</h2></div>`;
                return;
            }

            if (status === 'soon') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><i class="fas fa-clock text-5xl text-blue-400 mb-4"></i><h2 class="text-xl font-bold text-white mb-2">Ø¬ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ… (${activeDayNum})</h2></div>`;
                return;
            }

            if (currentUser.lastPlayedDay === activeDayNum) {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i><h2 class="text-xl font-bold text-white mb-2">ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­!</h2></div>`;
                return;
            }

            if (status === 'active' && !isQuizActive) {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><i class="fas fa-play-circle text-6xl text-yellow-500 mb-4"></i><h2 class="text-2xl font-black text-white mb-3">ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… (${activeDayNum})</h2><p class="text-gray-300 text-sm mb-6"><span class="text-red-400 font-bold">ØªÙ†Ø¨ÙŠÙ‡:</span> Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø© ÙŠÙ†Ù‡ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</p><button onclick="startQuizForDay(${activeDayNum})" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-black py-4 rounded-xl text-lg">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ</button></div>`;
            }
        });

        async function startQuizForDay(dayNumber) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-10 text-center"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-4"></i><p class="font-bold">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p></div>`;
            try {
                const daySnap = await db.collection("quizzes_pool").doc(`day_${dayNumber}`).get();
                if (daySnap.exists && daySnap.data().variations?.length > 0) {
                    const variations = daySnap.data().variations;
                    quizData = variations[Math.floor(Math.random() * variations.length)].questions;
                    currentQuestion = 0; tempScore = 0; detailedResults = []; isQuizActive = true; 
                    showQuestion();
                } else {
                    container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-400"><p>Ù„Ù… ØªÙ‚Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</p></div>`;
                }
            } catch (e) { container.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
        }

        // Ø§Ù„Ø£Ù…Ø§Ù†
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && isQuizActive) { alert("ğŸš« Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠÙ†Ù‡ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!"); isQuizActive = false; clearInterval(timerInterval); endQuiz(); }
        });
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
            if (isQuizActive) {
                if (confirm("âš ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙŠÙ†Ù‡ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!")) { isQuizActive = false; clearInterval(timerInterval); endQuiz(); }
                else { window.history.pushState(null, null, window.location.href); }
            } else { window.history.back(); }
        };

        function showQuestion() {
            if (currentQuestion >= quizData.length) return endQuiz();
            const q = quizData[currentQuestion];
            let html = `<div class="ramadan-card p-6 w-full"><div class="flex justify-between mb-5 text-xs text-gray-400"><span>Ø§Ù„ÙŠÙˆÙ… ${activeDayNum}</span><span class="text-yellow-500">Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} / ${quizData.length}</span></div><div class="w-full bg-gray-900 h-3 rounded-full mb-6 border border-gray-700 p-0.5"><div id="timer-bar" class="h-full bg-green-500 w-full rounded-full"></div></div><div class="text-center mb-6"><span id="timer-text" class="text-3xl font-black text-white">30</span></div><h2 class="text-xl md:text-2xl font-bold mb-8 text-center">${q.q}</h2><div class="space-y-3">`;
            q.options.forEach((opt, index) => { html += `<button onclick="handleAnswer(${index})" class="option-btn w-full text-right p-5 rounded-xl font-bold text-sm text-gray-200">${opt}</button>`; });
            html += `</div></div>`;
            document.getElementById('quiz-container').innerHTML = html;
            startTimer();
        }

        function startTimer() {
            timeLeft = 30; const timerBar = document.getElementById('timer-bar'); const timerText = document.getElementById('timer-text');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--; timerText.innerText = timeLeft;
                timerBar.style.width = ((timeLeft / 30) * 100) + '%';
                if(timeLeft <= 10) timerBar.classList.replace('bg-green-500', 'bg-red-500'); else if(timeLeft <= 20) timerBar.classList.replace('bg-green-500', 'bg-yellow-500');
                if (timeLeft <= 0) { clearInterval(timerInterval); handleAnswer(-1); }
            }, 1000);
        }

        function handleAnswer(selectedIndex) {
            clearInterval(timerInterval);
            detailedResults.push(selectedIndex === quizData[currentQuestion].correctIndex);
            if (selectedIndex === quizData[currentQuestion].correctIndex) tempScore += 1;
            currentQuestion++; showQuestion();
        }

        async function endQuiz() {
            isQuizActive = false; 
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-12 text-center"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-6"></i><p class="font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§ØªÙƒ...</p></div>`;
            try {
                await db.collection("users").doc(currentUser.id).update({ score: firebase.firestore.FieldValue.increment(tempScore), lastPlayedDay: activeDayNum });
                await db.collection("users").doc(currentUser.id).collection("game_logs").add({ day: activeDayNum, score: tempScore, results: detailedResults, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                
                currentUser.score = (currentUser.score || 0) + tempScore; 
                currentUser.lastPlayedDay = activeDayNum; 
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score;
                
                container.innerHTML = `<div class="ramadan-card p-8 text-center border-t-4 border-yellow-500"><i class="fas fa-trophy text-7xl text-yellow-500 mb-6"></i><h2 class="text-3xl font-black text-white mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©!</h2><p class="text-gray-400 mb-6 text-sm">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</p><div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 mb-8"><p class="text-sm text-gray-500 mb-2 font-bold">Ø­ØµØ¯Øª Ø§Ù„ÙŠÙˆÙ…</p><p class="text-5xl font-black text-yellow-500">${tempScore} <span class="text-lg text-gray-600">/ ${quizData.length}</span></p></div><button onclick="switchTab('leaderboard')" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl">Ø´Ø§Ù‡Ø¯ ØªØ±ØªÙŠØ¨ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ</button></div>`;
            } catch(e) { container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-500"><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©!</p></div>`; }
        }

        function logout() { 
            if (isQuizActive) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!"); return; }
            localStorage.clear(); window.location.href = "index.html"; 
        }
    </script>
</body>
</html>
