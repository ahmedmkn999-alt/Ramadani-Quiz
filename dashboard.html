<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙƒÙˆÙŠØ² Ø§Ù„Ø±Ù…Ø¶Ø§Ù†ÙŠ | Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body { 
            background-color: #050a15; 
            color: white; 
            font-family: 'Cairo', sans-serif; 
            background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); 
            overflow-x: hidden;
        }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ÙØ®Ù…Ø© (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…) */
        .ramadan-card { 
            background: rgba(13, 27, 42, 0.95); 
            border: 1px solid #b8860b; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-btn { transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: #000; font-weight: 900; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª */
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
        .option-btn {
            background: #112240;
            border: 1px solid #233f78;
            transition: all 0.2s;
        }
        .option-btn:active { transform: scale(0.95); background: #b8860b; color: black; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 pb-20">

    <div class="flex justify-center mb-4 mt-2">
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-24 h-24 object-contain rounded-full border-2 border-yellow-600 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="ramadan-card flex justify-between items-center p-4 rounded-2xl mb-6 w-full max-w-lg mx-auto">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center shadow-inner">
                <i class="fas fa-user text-2xl text-black"></i>
            </div>
            <div>
                <h2 id="player-name" class="font-bold text-white text-md truncate max-w-[120px]">---</h2>
                <p id="player-group" class="text-xs text-yellow-500 font-bold bg-yellow-900/30 px-2 py-0.5 rounded-full mt-1 inline-block">---</p>
            </div>
        </div>
        <div class="text-center bg-gray-900 p-2 rounded-xl border border-gray-700 min-w-[70px]">
            <p class="text-[10px] text-gray-400">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
            <p id="player-score" class="font-black text-xl text-yellow-500">0</p>
        </div>
    </header>

    <div class="flex bg-gray-900 rounded-xl p-1 mb-6 max-w-lg mx-auto w-full border border-gray-800">
        <button onclick="switchTab('arena')" id="btn-arena" class="tab-btn active flex-1 py-2 text-sm rounded-lg text-gray-400 font-bold">Ø§Ù„Ù…Ù„Ø¹Ø¨ âš½</button>
        <button onclick="switchTab('leaderboard')" id="btn-leaderboard" class="tab-btn flex-1 py-2 text-sm rounded-lg text-gray-400 font-bold">ØªØ±ØªÙŠØ¨ Ù…Ø¬Ù…ÙˆØ¹ØªÙŠ ğŸ†</button>
    </div>

    <main id="tab-arena" class="tab-content active flex-grow flex flex-col items-center w-full max-w-lg mx-auto">
        <div id="quiz-container" class="w-full">
            <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø¹Ø¨...</p></div>
        </div>
    </main>

    <main id="tab-leaderboard" class="tab-content flex-grow w-full max-w-lg mx-auto">
        <div class="ramadan-card p-5 rounded-2xl">
            <h3 class="text-yellow-500 font-bold mb-4 text-center border-b border-gray-700 pb-2">ÙØ±Ø³Ø§Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
            <div id="group-list" class="space-y-2">
                <div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </main>

    <div class="mt-auto pt-8 flex flex-col items-center gap-4">
        <div class="flex gap-6">
            <a href="https://www.facebook.com/share/1GmFwuYWZv/" target="_blank" class="text-gray-400 hover:text-blue-500 text-2xl"><i class="fab fa-facebook"></i></a>
            <a href="https://chat.whatsapp.com/D5dKR9EdHZjDPgrFpHl28J" target="_blank" class="text-gray-400 hover:text-green-500 text-2xl"><i class="fab fa-whatsapp"></i></a>
        </div>
        <button id="logout-btn" class="text-gray-600 text-xs font-bold hover:text-red-500"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, onSnapshot, serverTimestamp, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = "index.html";

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
        document.getElementById('player-name').innerText = currentUser.name;
        document.getElementById('player-group').innerText = currentUser.group;
        document.getElementById('player-score').innerText = currentUser.score || 0;

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙƒÙˆÙŠØ²
        let quizData = [];
        let currentQuestion = 0;
        let tempScore = 0; // Ø§Ù„Ù†Ù‚Ø· Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¬Ù…Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let detailedResults = [];
        let activeDayNum = 0;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯
        let timerInterval;
        let timeLeft = 30;

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            
            if(tabName === 'leaderboard') loadGroupLeaderboard();
        };

        // --- Ø¬Ù„Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ---
        async function loadGroupLeaderboard() {
            const listDiv = document.getElementById('group-list');
            try {
                const q = query(collection(db, "users"), where("group", "==", currentUser.group));
                const snap = await getDocs(q);
                let members = [];
                snap.forEach(d => members.push(d.data()));
                
                members.sort((a,b) => (b.score || 0) - (a.score || 0));
                
                listDiv.innerHTML = '';
                members.forEach((m, index) => {
                    let rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-700' : 'text-gray-500';
                    let isMe = m.name === currentUser.name ? 'border border-yellow-600 bg-gray-800' : 'bg-gray-900 border border-gray-800';
                    
                    listDiv.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-xl ${isMe}">
                            <div class="flex items-center gap-3">
                                <span class="font-black ${rankColor}">${index + 1}</span>
                                <span class="font-bold text-sm ${m.name === currentUser.name ? 'text-white' : 'text-gray-300'}">${m.name}</span>
                            </div>
                            <span class="font-black text-yellow-500">${m.score || 0}</span>
                        </div>
                    `;
                });
            } catch(e) { listDiv.innerHTML = '<p class="text-center text-red-500 text-xs">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</p>'; }
        }

        // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
        onSnapshot(doc(db, "settings", "global_status"), async (docSnap) => {
            const container = document.getElementById('quiz-container');
            if (!docSnap.exists()) return;
            
            const globalData = docSnap.data();
            const status = globalData.status;
            activeDayNum = globalData.currentDay;

            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userSnap = await getDoc(doc(db, "users", currentUser.id));
            if(userSnap.exists()) {
                currentUser = { id: userSnap.id, ...userSnap.data() };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score || 0;
            }

            // Ø±Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø£Ù†ÙŠÙ‚Ø© Ù„Ù„Ø­Ø§Ù„Ø§Øª
            if (status === 'closed') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-red-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-red-500"><i class="fas fa-lock text-3xl text-red-400"></i></div><h2 class="text-xl font-bold text-white mb-2">Ø§Ù„ØºØ±ÙØ© Ù…ØºÙ„Ù‚Ø©</h2><p class="text-gray-400 text-sm">ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„Ø¹Ø¨ Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¤Ù‚ØªØ§Ù‹.</p></div>`;
                return;
            }

            if (status === 'soon') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-blue-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-blue-500"><i class="fas fa-clock text-3xl text-blue-400"></i></div><h2 class="text-xl font-bold text-white mb-2">Ø¬ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ… (${activeDayNum})</h2><p class="text-gray-400 text-sm">Ø§Ù„ØªØ­Ø¯ÙŠ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯.. Ø§Ø³ØªØ¹Ø¯ÙˆØ§!</p></div>`;
                return;
            }

            if (currentUser.lastPlayedDay === activeDayNum) {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-green-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-green-500"><i class="fas fa-check text-4xl text-green-400"></i></div><h2 class="text-xl font-bold text-white mb-2">ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­!</h2><p class="text-gray-400 text-sm">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ… (${activeDayNum}).<br>Ø±Ø§Ø¬Ø¹ ØªØ±ØªÙŠØ¨ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ ÙˆØ§Ù†ØªØ¸Ø±Ù†Ø§ ØºØ¯Ø§Ù‹.</p></div>`;
                return;
            }

            if (status === 'active') {
                loadRandomQuizForDay(activeDayNum);
            }
        });

        // --- Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆÙŠØ² Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ ---
        async function loadRandomQuizForDay(dayNumber) {
            const container = document.getElementById('quiz-container');
            try {
                const daySnap = await getDoc(doc(db, "quizzes_pool", `day_${dayNumber}`));
                if (daySnap.exists() && daySnap.data().variations && daySnap.data().variations.length > 0) {
                    const variations = daySnap.data().variations;
                    const randomIndex = Math.floor(Math.random() * variations.length);
                    quizData = variations[randomIndex].questions;
                    currentQuestion = 0;
                    tempScore = 0;
                    detailedResults = [];
                    showQuestion();
                } else {
                    container.innerHTML = `<div class="ramadan-card p-6 text-center text-red-400 text-sm">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</div>`;
                }
            } catch (e) { console.error(e); }
        }

        // --- Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ ---
        function showQuestion() {
            if (currentQuestion >= quizData.length) return endQuiz();
            const q = quizData[currentQuestion];
            
            let html = `
                <div class="ramadan-card p-5 w-full">
                    <div class="flex justify-between items-center mb-4 text-xs font-bold text-gray-400 border-b border-gray-700 pb-2">
                        <span>Ø§Ù„ÙŠÙˆÙ… ${activeDayNum}</span>
                        <span class="text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded">Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} / ${quizData.length}</span>
                    </div>
                    
                    <div class="w-full bg-gray-800 h-2 rounded-full mb-6 overflow-hidden">
                        <div id="timer-bar" class="h-full bg-green-500 w-full"></div>
                    </div>
                    <div class="text-center mb-4">
                        <span id="timer-text" class="text-xl font-black text-white">30</span>
                    </div>

                    <h2 class="text-lg md:text-xl font-bold mb-6 text-center leading-relaxed">${q.q}</h2>
                    
                    <div class="space-y-3">
            `;
            q.options.forEach((opt, index) => {
                html += `<button onclick="handleAnswer(${index})" class="option-btn w-full text-right p-4 rounded-xl font-bold text-sm text-gray-200">${opt}</button>`;
            });
            html += `</div></div>`;
            
            document.getElementById('quiz-container').innerHTML = html;
            startTimer();
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ---
        function startTimer() {
            timeLeft = 30;
            const timerBar = document.getElementById('timer-bar');
            const timerText = document.getElementById('timer-text');
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.innerText = timeLeft;
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ·
                const percentage = (timeLeft / 30) * 100;
                timerBar.style.width = percentage + '%';
                
                // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ù„Ù…Ø§ Ø§Ù„ÙˆÙ‚Øª ÙŠÙ‚Ø±Ø¨ ÙŠØ®Ù„Øµ
                if(timeLeft <= 10) timerBar.classList.replace('bg-green-500', 'bg-red-500');
                else if(timeLeft <= 20) timerBar.classList.replace('bg-green-500', 'bg-yellow-500');

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1); // -1 ÙŠØ¹Ù†ÙŠ Ø§Ù„ÙˆÙ‚Øª Ø®Ù„Øµ ÙˆÙ…ÙÙŠØ´ Ø¥Ø¬Ø§Ø¨Ø© Ø§ØªØ­Ø¯Ø¯Øª
                }
            }, 1000);
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©) ---
        window.handleAnswer = (selectedIndex) => {
            clearInterval(timerInterval); // ÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const q = quizData[currentQuestion];
            const isCorrect = (selectedIndex === q.correctIndex);
            
            detailedResults.push(isCorrect);
            if (isCorrect) tempScore += 1;
            
            currentQuestion++;
            showQuestion(); // Ø§Ø¯Ø®Ù„ Ø¹Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ ÙÙˆØ±Ø§Ù‹
        };

        // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆÙŠØ² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        async function endQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-10 text-center"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p class="font-bold">Ø¬Ø§Ø±ÙŠ Ø±ØµØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§...</p></div>`;
            
            try {
                const userRef = doc(db, "users", currentUser.id);
                await updateDoc(userRef, { 
                    score: increment(tempScore),
                    lastPlayedDay: activeDayNum 
                });
                
                await addDoc(collection(userRef, "game_logs"), {
                    day: activeDayNum,
                    score: tempScore,
                    results: detailedResults,
                    timestamp: serverTimestamp()
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙƒØ§Ù„ ÙˆØ§Ù„Ù€ UI
                currentUser.score = (currentUser.score || 0) + tempScore;
                currentUser.lastPlayedDay = activeDayNum;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score;

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·
                container.innerHTML = `
                    <div class="ramadan-card p-8 text-center">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-white mb-2">Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„!</h2>
                        <p class="text-gray-300 mb-6 text-sm">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­</p>
                        <div class="bg-gray-900 border border-yellow-600 rounded-xl p-4 mb-6 inline-block">
                            <p class="text-xs text-gray-400 mb-1">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙŠ Ø­ØµØ¯ØªÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ…</p>
                            <p class="text-3xl font-black text-yellow-500">${tempScore} <span class="text-sm text-gray-500">Ù…Ù† ${quizData.length}</span></p>
                        </div>
                        <button onclick="switchTab('leaderboard')" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-bold py-3 rounded-xl shadow-lg">Ø´Ø§Ù‡Ø¯ ØªØ±ØªÙŠØ¨Ùƒ Ø§Ù„Ø¢Ù†</button>
                    </div>
                `;
            } catch(e) { container.innerHTML = `<div class="ramadan-card p-6 text-center text-red-500 text-sm">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©! ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.</div>`; }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.clear(); window.location.href = "index.html";
        });
    </script>
</body>
</html>
