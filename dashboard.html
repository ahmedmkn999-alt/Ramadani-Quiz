<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>كويز الرمضاني | خريطة التحديات</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { background-color: #050a15; color: white; font-family: 'Cairo', sans-serif; background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); overflow-x: hidden; }
        .ramadan-card { background: rgba(13, 27, 42, 0.95); border: 1px solid #b8860b; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .tab-btn { transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: #000; font-weight: 900; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        .option-btn { background: #112240; border: 1px solid #233f78; transition: all 0.2s; }
        .option-btn:active { transform: scale(0.95); background: #b8860b; color: black; }
        .day-card { transition: transform 0.2s; }
        .day-card.active-day { animation: pulseGlow 2s infinite; cursor: pointer; }
        .day-card.active-day:active { transform: scale(0.98); }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 5px rgba(184,134,11,0.2); } 50% { box-shadow: 0 0 20px rgba(184,134,11,0.6); } 100% { box-shadow: 0 0 5px rgba(184,134,11,0.2); } }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 pb-10">

    <div class="flex justify-between items-center w-full max-w-lg mx-auto mb-2">
        <button onclick="logoutUser()" class="text-red-400 bg-red-900/20 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-red-900/50 hover:text-white transition border border-red-900 shadow-md">
            <i class="fas fa-sign-out-alt ml-1"></i> تسجيل خروج
        </button>
        <div></div> 
    </div>

    <div class="flex justify-center mb-4">
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-24 h-24 object-contain rounded-full border-2 border-yellow-600 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="ramadan-card flex justify-between items-center p-4 rounded-2xl mb-6 w-full max-w-lg mx-auto">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-2xl text-black"></i>
            </div>
            <div>
                <h2 id="player-name" class="font-bold text-white text-md">...</h2>
                <p id="player-group" class="text-xs text-yellow-500 font-bold">...</p>
            </div>
        </div>
        <div class="text-center bg-gray-900 p-2 rounded-xl border border-gray-700 min-w-[70px]">
            <p class="text-[10px] text-gray-400">النقاط</p>
            <p id="player-score" class="font-black text-xl text-yellow-500">0</p>
        </div>
    </header>

    <div class="flex bg-gray-900 rounded-xl p-1 mb-6 max-w-lg mx-auto w-full border border-gray-800">
        <button onclick="switchTab('arena')" id="btn-arena" class="tab-btn active flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-map-marked-alt"></i> التحديات</button>
        <button onclick="switchTab('leaderboard')" id="btn-leaderboard" class="tab-btn flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-trophy"></i> مجموعتي</button>
    </div>

    <main id="tab-arena" class="tab-content active flex-grow flex flex-col items-center w-full max-w-lg mx-auto">
        <div id="days-map-container" class="w-full space-y-3">
            <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p id="loading-msg">جاري تحميل النظام...</p></div>
        </div>
        <div id="quiz-container" class="w-full hidden"></div>
    </main>

    <main id="tab-leaderboard" class="tab-content flex-grow w-full max-w-lg mx-auto">
        <div class="ramadan-card p-5 rounded-2xl">
            <h3 class="text-yellow-500 font-bold mb-4 text-center border-b border-gray-700 pb-2">فرسان المجموعة</h3>
            <div id="group-list" class="space-y-2"><p class="text-center text-gray-400 py-4">جاري التحميل...</p></div>
        </div>
    </main>

    <div class="mt-auto pt-8 flex justify-center gap-6">
        <a href="https://www.facebook.com/share/1GmFwuYWZv/" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white hover:bg-blue-600 transition shadow-lg border border-gray-700"><i class="fab fa-facebook text-xl"></i></a>
        <a href="https://chat.whatsapp.com/D5dKR9EdHZjDPgrFpHl28J" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white hover:bg-green-600 transition shadow-lg border border-gray-700"><i class="fab fa-whatsapp text-xl"></i></a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // 1. التأكد من بيانات المتسابق بأمان
        let currentUser = null;
        let userId = null;

        try {
            let storedData = localStorage.getItem('currentUser');
            if (storedData) {
                currentUser = JSON.parse(storedData);
                userId = currentUser.id || currentUser.uid;
            }
        } catch(e) {}

        if (!currentUser || !userId) {
            window.location.replace("index.html");
        }

        // عرض البيانات فوراً
        document.getElementById('player-name').innerText = currentUser.name || "مستخدم";
        document.getElementById('player-group').innerText = currentUser.group || "مجموعة";
        document.getElementById('player-score').innerText = currentUser.score || 0;

        // 2. إعداد قاعدة البيانات (Firebase Compat)
        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        // 3. المتغيرات
        let playedDaysData = {};
        let activeAdminDay = 1;
        let adminStatus = "closed";
        let adminExpiry = null;
        let isQuizActive = false;
        
        let quizData = [];
        let currentQuestion = 0;
        let tempScore = 0;
        let detailedResults = [];
        let timerInterval;
        let timeLeft = 30;

        // 4. دوال التحكم والزراير
        function switchTab(tabName) {
            if (isQuizActive) { alert("⚠️ لا يمكنك التنقل أثناء الاختبار!"); return; }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            
            if(tabName === 'arena') {
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('days-map-container').classList.remove('hidden');
                renderMap();
            }
            if(tabName === 'leaderboard') { fetchLeaderboard(); }
        }

        function logoutUser() {
            if (isQuizActive) { alert("لا يمكنك الخروج أثناء الاختبار!"); return; }
            localStorage.removeItem('currentUser');
            window.location.replace("index.html");
        }

        // 5. التشغيل وجلب البيانات
        function bootSystem() {
            // جلب الأيام الملعوبة
            db.collection("users").doc(userId).collection("game_logs").get().then(function(snap) {
                playedDaysData = {};
                snap.forEach(function(doc) {
                    playedDaysData[doc.data().day] = doc.data().score;
                });
            }).catch(function(err) { console.log("لا يوجد سجل"); });

            // الاستماع لحالة الإدارة
            db.collection("settings").doc("global_status").onSnapshot(function(docSnap) {
                if (!docSnap.exists) {
                    adminStatus = "closed";
                    activeAdminDay = 1;
                    renderMap();
                    return;
                }

                let globalData = docSnap.data();
                adminStatus = globalData.status || "closed";
                activeAdminDay = globalData.currentDay || 1;
                adminExpiry = globalData.expiryTime;

                // تحديث النقط
                db.collection("users").doc(userId).get().then(function(userSnap) {
                    if (userSnap.exists) {
                        currentUser.score = userSnap.data().score || currentUser.score;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        document.getElementById('player-score').innerText = currentUser.score;
                    }
                }).catch(function(){});

                if (adminExpiry && Date.now() > adminExpiry && isQuizActive) {
                    isQuizActive = false;
                    clearInterval(timerInterval);
                    finishQuiz(true);
                    return;
                }

                renderMap();
            }, function(error) {
                document.getElementById('loading-msg').innerText = "خطأ في الاتصال بالإنترنت";
            });
        }

        // 6. رسم الخريطة
        function renderMap() {
            if (isQuizActive) return; 
            
            const container = document.getElementById('days-map-container');
            let html = '';

            for (let i = 1; i <= 30; i++) {
                if (playedDaysData[i] !== undefined) {
                    html += `<div class="day-card bg-gray-900 border border-green-700 p-4 rounded-xl flex justify-between items-center opacity-80"><div class="flex items-center gap-3"><div class="bg-green-900/50 w-10 h-10 rounded-full flex items-center justify-center text-green-500"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-gray-200">تحدي اليوم (${i})</h3><p class="text-xs text-green-400">تم الإنجاز بنجاح</p></div></div><div class="text-center"><p class="text-[10px] text-gray-500">النتيجة</p><p class="font-black text-yellow-500">${playedDaysData[i]}</p></div></div>`;
                } else if (i === activeAdminDay) {
                    if (adminStatus === 'active') {
                        if (adminExpiry && Date.now() > adminExpiry) {
                            html += `<div class="day-card bg-gray-900 border border-red-900 p-4 rounded-xl flex justify-between items-center opacity-70"><div class="flex items-center gap-3"><div class="bg-red-900/50 w-10 h-10 rounded-full flex items-center justify-center text-red-500"><i class="fas fa-hourglass-end"></i></div><div><h3 class="font-bold text-gray-400">تحدي اليوم (${i})</h3><p class="text-xs text-red-500">انتهى وقت الجولة</p></div></div></div>`;
                        } else {
                            html += `<div onclick="prepareQuiz(${i})" class="day-card active-day bg-gradient-to-r from-gray-900 to-gray-800 border-2 border-yellow-500 p-4 rounded-xl flex justify-between items-center shadow-lg"><div class="flex items-center gap-3"><div class="bg-yellow-500 w-10 h-10 rounded-full flex items-center justify-center text-black shadow-inner"><i class="fas fa-play ml-1"></i></div><div><h3 class="font-bold text-white text-lg">تحدي اليوم (${i})</h3><p class="text-xs text-yellow-500 font-bold animate-pulse">متاح الآن.. اضغط للبدء!</p></div></div><i class="fas fa-chevron-left text-yellow-500 opacity-50"></i></div>`;
                        }
                    } else if (adminStatus === 'soon') {
                        html += `<div class="day-card bg-gray-900 border border-blue-900 p-4 rounded-xl flex justify-between items-center opacity-80"><div class="flex items-center gap-3"><div class="bg-blue-900/50 w-10 h-10 rounded-full flex items-center justify-center text-blue-500"><i class="fas fa-clock"></i></div><div><h3 class="font-bold text-blue-100">تحدي اليوم (${i})</h3><p class="text-xs text-blue-400">يفتح قريباً.. استعد</p></div></div></div>`;
                    } else {
                        html += `<div class="day-card bg-gray-900 border border-gray-700 p-4 rounded-xl flex justify-between items-center opacity-60"><div class="flex items-center gap-3"><div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-gray-500"><i class="fas fa-lock"></i></div><div><h3 class="font-bold text-gray-500">تحدي اليوم (${i})</h3><p class="text-xs text-red-400">مغلق من الإدارة</p></div></div></div>`;
                    }
                } else if (i < activeAdminDay) {
                    html += `<div class="day-card bg-gray-900 border border-gray-800 p-4 rounded-xl flex justify-between items-center opacity-50"><div class="flex items-center gap-3"><div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-gray-600"><i class="fas fa-times"></i></div><div><h3 class="font-bold text-gray-600">تحدي اليوم (${i})</h3><p class="text-xs text-gray-500">جولة سابقة (مغلقة)</p></div></div><span class="text-xs text-red-900 font-bold border border-red-900 px-2 rounded">فائت</span></div>`;
                } else {
                    html += `<div class="day-card bg-gray-900/50 border border-gray-800/50 p-4 rounded-xl flex justify-between items-center opacity-40"><div class="flex items-center gap-3"><div class="bg-gray-800/50 w-10 h-10 rounded-full flex items-center justify-center text-gray-600"><i class="fas fa-lock"></i></div><div><h3 class="font-bold text-gray-600">تحدي اليوم (${i})</h3><p class="text-[10px] text-gray-500">لم يحن وقته بعد</p></div></div></div>`;
                }
            }
            container.innerHTML = html;
        }

        // 7. تجهيز الكويز
        function prepareQuiz(dayNum) {
            document.getElementById('days-map-container').classList.add('hidden');
            const qc = document.getElementById('quiz-container');
            qc.classList.remove('hidden');

            qc.innerHTML = `<div class="ramadan-card p-8 text-center w-full shadow-2xl mt-4"><div class="bg-gradient-to-br from-yellow-500 to-yellow-700 w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner border-4 border-gray-900"><i class="fas fa-play text-4xl text-black ml-2"></i></div><h2 class="text-2xl font-black text-white mb-3">تجهيز تحدي اليوم (${dayNum})</h2><p class="text-gray-300 text-sm mb-6 leading-relaxed bg-gray-900/50 p-4 rounded-lg border border-gray-800"><i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> لديك 30 ثانية لكل سؤال.<br><span class="text-red-400 font-bold">تنبيه حازم:</span> الخروج من الصفحة ينهي الاختبار فوراً!</p><button onclick="runQuiz(${dayNum})" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-black py-4 rounded-xl shadow-lg text-lg transition active:scale-95">دخول الملعب ⚽</button><button onclick="switchTab('arena')" class="w-full mt-4 text-gray-500 text-sm hover:text-white">رجوع للخريطة</button></div>`;
        }

        function runQuiz(dayNum) {
            const qc = document.getElementById('quiz-container');
            qc.innerHTML = `<div class="ramadan-card p-10 text-center mt-4"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-4"></i><p class="font-bold">سحب الأسئلة...</p></div>`;
            
            db.collection("quizzes_pool").doc("day_" + dayNum).get().then(function(snap) {
                if (snap.exists && snap.data().variations && snap.data().variations.length > 0) {
                    let vars = snap.data().variations;
                    quizData = vars[Math.floor(Math.random() * vars.length)].questions;
                    currentQuestion = 0; 
                    tempScore = 0; 
                    detailedResults = []; 
                    isQuizActive = true; 
                    showCurrentQuestion();
                } else {
                    qc.innerHTML = `<div class="ramadan-card p-8 text-center text-red-400 mt-4"><p>خطأ: الإدارة لم ترفع أسئلة بعد.</p><button onclick="switchTab('arena')" class="mt-4 bg-gray-800 text-white px-4 py-2 rounded">رجوع</button></div>`;
                }
            }).catch(function(e) {
                qc.innerHTML = `<div class="ramadan-card p-8 text-center text-red-400 mt-4"><p>خطأ اتصال بالسيرفر</p><button onclick="switchTab('arena')" class="mt-4 bg-gray-800 text-white px-4 py-2 rounded">رجوع</button></div>`;
            });
        }

        function showCurrentQuestion() {
            if (currentQuestion >= quizData.length) {
                finishQuiz(false);
                return;
            }
            
            const q = quizData[currentQuestion];
            let html = `<div class="ramadan-card p-6 w-full mt-4"><div class="flex justify-between mb-5 text-xs text-gray-400"><span>تحدي ${activeAdminDay}</span><span class="text-yellow-500">سؤال ${currentQuestion + 1} / ${quizData.length}</span></div><div class="w-full bg-gray-900 h-3 rounded-full mb-6 border border-gray-700 p-0.5"><div id="timer-bar" class="h-full bg-green-500 w-full rounded-full"></div></div><div class="text-center mb-6"><span id="timer-text" class="text-3xl font-black text-white">30</span></div><h2 class="text-xl md:text-2xl font-bold mb-8 text-center leading-relaxed text-white">${q.q}</h2><div class="space-y-3">`;
            
            q.options.forEach(function(opt, idx) { 
                html += `<button onclick="processAnswer(${idx})" class="option-btn w-full text-right p-5 rounded-xl font-bold text-sm text-gray-200">${opt}</button>`; 
            });
            
            html += `</div></div>`;
            document.getElementById('quiz-container').innerHTML = html;
            startCountdown();
        }

        function startCountdown() {
            timeLeft = 30; 
            const timerBar = document.getElementById('timer-bar'); 
            const timerText = document.getElementById('timer-text');
            clearInterval(timerInterval);
            
            timerInterval = setInterval(function() {
                timeLeft--; 
                timerText.innerText = timeLeft;
                timerBar.style.width = ((timeLeft / 30) * 100) + '%';
                
                if(timeLeft <= 10) timerBar.classList.replace('bg-green-500', 'bg-red-500'); 
                else if(timeLeft <= 20) timerBar.classList.replace('bg-green-500', 'bg-yellow-500');
                
                if (timeLeft <= 0) { 
                    clearInterval(timerInterval); 
                    processAnswer(-1); 
                }
            }, 1000);
        }

        function processAnswer(idx) {
            clearInterval(timerInterval);
            let isCorrect = (idx === quizData[currentQuestion].correctIndex);
            detailedResults.push(isCorrect);
            if (isCorrect) tempScore += 1;
            
            currentQuestion++; 
            showCurrentQuestion();
        }

        function finishQuiz(forced) {
            isQuizActive = false; 
            const qc = document.getElementById('quiz-container');
            qc.innerHTML = `<div class="ramadan-card p-12 text-center mt-4"><i cl
