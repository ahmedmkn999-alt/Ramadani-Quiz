<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>كويز الرمضاني | لوحة المتسابق</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body { 
            background-color: #050a15; 
            color: white; 
            font-family: 'Cairo', sans-serif; 
            background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); 
            overflow-x: hidden;
        }

        /* ستايل الكروت الفخمة */
        .ramadan-card { 
            background: rgba(13, 27, 42, 0.95); 
            border: 1px solid #b8860b; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* التبويبات */
        .tab-btn { transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: #000; font-weight: 900; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* شريط الوقت */
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        
        /* أزرار الإجابات */
        .option-btn {
            background: #112240;
            border: 1px solid #233f78;
            transition: all 0.2s;
        }
        .option-btn:active { transform: scale(0.95); background: #b8860b; color: black; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 pb-20">

    <div class="flex justify-center mb-4 mt-2">
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-24 h-24 object-contain rounded-full border-2 border-yellow-600 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="ramadan-card flex justify-between items-center p-4 rounded-2xl mb-6 w-full max-w-lg mx-auto">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center shadow-inner">
                <i class="fas fa-user text-2xl text-black"></i>
            </div>
            <div>
                <h2 id="player-name" class="font-bold text-white text-md truncate max-w-[120px]">---</h2>
                <p id="player-group" class="text-xs text-yellow-500 font-bold bg-yellow-900/30 px-2 py-0.5 rounded-full mt-1 inline-block">---</p>
            </div>
        </div>
        <div class="text-center bg-gray-900 p-2 rounded-xl border border-gray-700 min-w-[70px]">
            <p class="text-[10px] text-gray-400">النقاط</p>
            <p id="player-score" class="font-black text-xl text-yellow-500">0</p>
        </div>
    </header>

    <div class="flex bg-gray-900 rounded-xl p-1 mb-6 max-w-lg mx-auto w-full border border-gray-800 shadow-lg">
        <button onclick="switchTab('arena')" id="btn-arena" class="tab-btn active flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-futbol ml-1"></i> الملعب</button>
        <button onclick="switchTab('leaderboard')" id="btn-leaderboard" class="tab-btn flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-trophy ml-1"></i> ترتيب مجموعتي</button>
    </div>

    <main id="tab-arena" class="tab-content active flex-grow flex flex-col items-center w-full max-w-lg mx-auto">
        <div id="quiz-container" class="w-full">
            <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>جاري تحميل الملعب...</p></div>
        </div>
    </main>

    <main id="tab-leaderboard" class="tab-content flex-grow w-full max-w-lg mx-auto">
        <div class="ramadan-card p-5 rounded-2xl">
            <h3 class="text-yellow-500 font-bold mb-4 text-center border-b border-gray-700 pb-2">فرسان المجموعة</h3>
            <div id="group-list" class="space-y-2">
                <div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
            </div>
        </div>
    </main>

    <div class="mt-auto pt-8 flex flex-col items-center gap-4">
        <div class="flex gap-6">
            <a href="https://www.facebook.com/share/1GmFwuYWZv/" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white hover:bg-blue-600 transition shadow-lg"><i class="fab fa-facebook text-xl"></i></a>
            <a href="https://chat.whatsapp.com/D5dKR9EdHZjDPgrFpHl28J" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white hover:bg-green-600 transition shadow-lg"><i class="fab fa-whatsapp text-xl"></i></a>
        </div>
        <button id="logout-btn" class="text-gray-600 text-xs font-bold hover:text-red-500 transition mt-2"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = "index.html";

        // تحديث بيانات الهيدر
        document.getElementById('player-name').innerText = currentUser.name;
        document.getElementById('player-group').innerText = currentUser.group;
        document.getElementById('player-score').innerText = currentUser.score || 0;

        // متغيرات الكويز
        let quizData = [];
        let currentQuestion = 0;
        let tempScore = 0;
        let detailedResults = [];
        let activeDayNum = 0;
        
        // متغيرات العداد
        let timerInterval;
        let timeLeft = 30;

        // --- التبويبات ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            
            if(tabName === 'leaderboard') loadGroupLeaderboard();
        };

        // --- جلب الترتيب ---
        async function loadGroupLeaderboard() {
            const listDiv = document.getElementById('group-list');
            try {
                const q = query(collection(db, "users"), where("group", "==", currentUser.group));
                const snap = await getDocs(q);
                let members = [];
                snap.forEach(d => members.push(d.data()));
                
                members.sort((a,b) => (b.score || 0) - (a.score || 0));
                
                listDiv.innerHTML = '';
                members.forEach((m, index) => {
                    let rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-700' : 'text-gray-500';
                    let isMe = m.name === currentUser.name ? 'border-2 border-yellow-600 bg-gray-800 transform scale-105 my-2 shadow-lg' : 'bg-gray-900 border border-gray-800';
                    
                    listDiv.innerHTML += `
                        <div class="flex justify-between items-center p-4 rounded-xl transition ${isMe}">
                            <div class="flex items-center gap-4">
                                <span class="font-black text-lg ${rankColor}">${index + 1}</span>
                                <span class="font-bold text-sm ${m.name === currentUser.name ? 'text-white' : 'text-gray-300'}">${m.name}</span>
                            </div>
                            <span class="font-black text-yellow-500 text-lg">${m.score || 0}</span>
                        </div>
                    `;
                });
            } catch(e) { listDiv.innerHTML = '<p class="text-center text-red-500 text-xs">خطأ في جلب الترتيب</p>'; }
        }

        // --- الاستماع لحالة الموقع من الإدارة ---
        onSnapshot(doc(db, "settings", "global_status"), async (docSnap) => {
            const container = document.getElementById('quiz-container');
            if (!docSnap.exists()) return;
            
            const globalData = docSnap.data();
            const status = globalData.status;
            activeDayNum = globalData.currentDay;

            // تحديث النقط من السيرفر للتأكد
            const userSnap = await getDoc(doc(db, "users", currentUser.id));
            if(userSnap.exists()) {
                currentUser = { id: userSnap.id, ...userSnap.data() };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score || 0;
            }

            if (status === 'closed') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-red-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-red-500"><i class="fas fa-lock text-3xl text-red-400"></i></div><h2 class="text-xl font-bold text-white mb-2">الغرفة مغلقة</h2><p class="text-gray-400 text-sm">تم إغلاق اللعب من قِبل الإدارة مؤقتاً.</p></div>`;
                return;
            }

            if (status === 'soon') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-blue-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-blue-500"><i class="fas fa-clock text-3xl text-blue-400"></i></div><h2 class="text-xl font-bold text-white mb-2">جولة اليوم (${activeDayNum})</h2><p class="text-gray-400 text-sm">التحدي لم يبدأ بعد.. استعدوا!</p></div>`;
                return;
            }

            if (currentUser.lastPlayedDay === activeDayNum) {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-green-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-green-500"><i class="fas fa-check-circle text-4xl text-green-400"></i></div><h2 class="text-xl font-bold text-white mb-2">أنت أنهيت جولة اليوم بنجاح!</h2><p class="text-gray-400 text-sm leading-relaxed">لقد أكملت أسئلة اليوم (${activeDayNum}).<br>راجع ترتيب مجموعتك في التبويب الآخر وانتظرنا غداً!</p></div>`;
                return;
            }

            // --- التعديل الأهم: شاشة "البدء" قبل الكويز ---
            if (status === 'active') {
                showStartScreen();
            }
        });

        // --- شاشة ما قبل الكويز ---
        function showStartScreen() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="ramadan-card p-8 text-center w-full shadow-2xl transform transition hover:scale-105">
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-700 w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner border-4 border-gray-900">
                        <i class="fas fa-play text-4xl text-black ml-2"></i>
                    </div>
                    <h2 class="text-2xl font-black text-white mb-3">تحدي اليوم (${activeDayNum})</h2>
                    <p class="text-gray-300 text-sm mb-6 leading-relaxed bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> لديك 30 ثانية لكل سؤال، لا يمكنك التراجع بعد الاختيار. هل أنت مستعد للسيطرة؟
                    </p>
                    <button onclick="startQuizForDay(${activeDayNum})" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-black py-4 rounded-xl shadow-[0_0_15px_rgba(184,134,11,0.4)] text-lg transition active:scale-95">
                        دخول الملعب وبدء التحدي
                    </button>
                </div>
            `;
        }

        // --- جلب الكويز العشوائي بعد الضغط على "بدء" ---
        window.startQuizForDay = async (dayNumber) => {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-10 text-center"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-4"></i><p class="font-bold animate-pulse">جاري تجهيز الأسئلة...</p></div>`;
            
            try {
                const daySnap = await getDoc(doc(db, "quizzes_pool", `day_${dayNumber}`));
                if (daySnap.exists() && daySnap.data().variations && daySnap.data().variations.length > 0) {
                    const variations = daySnap.data().variations;
                    const randomIndex = Math.floor(Math.random() * variations.length);
                    quizData = variations[randomIndex].questions;
                    currentQuestion = 0;
                    tempScore = 0;
                    detailedResults = [];
                    showQuestion();
                } else {
                    container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-400"><i class="fas fa-times-circle text-4xl mb-4"></i><p>عذراً، لم تقم الإدارة برفع أسئلة اليوم بعد.</p></div>`;
                }
            } catch (e) { console.error(e); }
        };

        // --- عرض السؤال والعداد ---
        function showQuestion() {
            if (currentQuestion >= quizData.length) return endQuiz();
            const q = quizData[currentQuestion];
            
            let html = `
                <div class="ramadan-card p-6 w-full shadow-2xl">
                    <div class="flex justify-between items-center mb-5 text-xs font-bold text-gray-400 border-b border-gray-700 pb-3">
                        <span class="bg-gray-800 px-3 py-1 rounded-lg">اليوم ${activeDayNum}</span>
                        <span class="text-yellow-500 bg-yellow-900/30 px-3 py-1 rounded-lg">سؤال ${currentQuestion + 1} / ${quizData.length}</span>
                    </div>
                    
                    <div class="w-full bg-gray-900 h-3 rounded-full mb-6 overflow-hidden border border-gray-700 p-0.5">
                        <div id="timer-bar" class="h-full bg-green-500 w-full rounded-full"></div>
                    </div>
                    <div class="text-center mb-6">
                        <span id="timer-text" class="text-3xl font-black text-white drop-shadow-md">30</span>
                    </div>

                    <h2 class="text-xl md:text-2xl font-bold mb-8 text-center leading-relaxed text-white drop-shadow-md">${q.q}</h2>
                    
                    <div class="space-y-3">
            `;
            q.options.forEach((opt, index) => {
                html += `<button onclick="handleAnswer(${index})" class="option-btn w-full text-right p-5 rounded-xl font-bold text-sm md:text-base text-gray-200 shadow-md">${opt}</button>`;
            });
            html += `</div></div>`;
            
            document.getElementById('quiz-container').innerHTML = html;
            startTimer();
        }

        // --- منطق العداد ---
        function startTimer() {
            timeLeft = 30;
            const timerBar = document.getElementById('timer-bar');
            const timerText = document.getElementById('timer-text');
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.innerText = timeLeft;
                
                const percentage = (timeLeft / 30) * 100;
                timerBar.style.width = percentage + '%';
                
                if(timeLeft <= 10) timerBar.classList.replace('bg-green-500', 'bg-red-500');
                else if(timeLeft <= 20) timerBar.classList.replace('bg-green-500', 'bg-yellow-500');

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1); // الوقت خلص
                }
            }, 1000);
        }

        // --- معالجة الإجابة والتنقل الفوري (بدون إظهار النتيجة) ---
        window.handleAnswer = (selectedIndex) => {
            clearInterval(timerInterval); // وقف العداد فوراً
            const q = quizData[currentQuestion];
            const isCorrect = (selectedIndex === q.correctIndex);
            
            detailedResults.push(isCorrect);
            if (isCorrect) tempScore += 1;
            
            currentQuestion++;
            showQuestion(); // السؤال التالي مباشرة
        };

        // --- نهاية الكويز وإرسال البيانات ---
        async function endQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-12 text-center shadow-2xl"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-6"></i><p class="font-bold text-lg animate-pulse">جاري رصد درجاتك في السيرفر...</p></div>`;
            
            try {
                const userRef = doc(db, "users", currentUser.id);
                await updateDoc(userRef, { 
                    score: increment(tempScore),
                    lastPlayedDay: activeDayNum 
                });
                
                await addDoc(collection(userRef, "game_logs"), {
                    day: activeDayNum,
                    score: tempScore,
                    results: detailedResults,
                    timestamp: serverTimestamp()
                });

                currentUser.score = (currentUser.score || 0) + tempScore;
                currentUser.lastPlayedDay = activeDayNum;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score;

                // كارت النتيجة النهائية
                container.innerHTML = `
                    <div class="ramadan-card p-8 text-center shadow-2xl border-t-4 border-yellow-500">
                        <i class="fas fa-trophy text-7xl text-yellow-500 mb-6 drop-shadow-lg"></i>
                        <h2 class="text-3xl font-black text-white mb-2">انتهت المعركة!</h2>
                        <p class="text-gray-400 mb-6 text-sm">تم تسجيل نتيجتك لليوم (${activeDayNum}) بنجاح</p>
                        
                        <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 mb-8 shadow-inner">
                            <p class="text-sm text-gray-500 mb-2 font-bold">النقاط التي حصدتها اليوم</p>
                            <p class="text-5xl font-black text-yellow-500 drop-shadow-md">${tempScore} <span class="text-lg text-gray-600">/ ${quizData.length}</span></p>
                        </div>
                        
                        <button onclick="switchTab('leaderboard')" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold py-4 rounded-xl shadow-lg transition text-lg">
                            <i class="fas fa-list-ol ml-2"></i> شاهد ترتيب مجموعتك
                        </button>
                    </div>
                `;
            } catch(e) { container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-500 border-t-4 border-red-500"><i class="f
