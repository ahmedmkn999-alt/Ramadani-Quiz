<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ูููุฒ ุงูุฑูุถุงูู | ุงูููุงูุณุฉ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body { 
            background-color: #050a15; 
            color: white; 
            font-family: 'Cairo', sans-serif; 
            background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); 
            overflow-x: hidden;
        }

        .glass-card { 
            background: rgba(13, 27, 42, 0.95); 
            border: 1px solid #b8860b; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .option-btn {
            background-color: #1e293b;
            border: 2px solid #334155;
            transition: all 0.3s ease;
        }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.correct { background-color: #16a34a !important; border-color: #15803d !important; color: white; }
        .option-btn.wrong { background-color: #dc2626 !important; border-color: #991b1b !important; color: white; }

        /* ุดุฑูุท ุงูููุช */
        #timer-bar { transition: width 1s linear; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-gray-900 border-b-4 border-yellow-600 p-4 sticky top-0 z-50 shadow-xl">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl shadow-lg">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h1 id="user-name" class="font-bold text-sm text-yellow-500">ุฌุงุฑู ุงูุชุญููู...</h1>
                    <p id="user-group" class="text-xs text-gray-400">ุงููุฌููุนุฉ</p>
                </div>
            </div>
            <div class="text-center">
                <div class="bg-gray-800 px-4 py-1 rounded-lg border border-gray-700">
                    <span class="text-[10px] text-gray-400 block">ุฅุฌูุงูู ุงูููุงุท</span>
                    <span id="user-score" class="font-black text-lg text-white">0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
        <div id="dynamic-container" class="w-full max-w-md">
            
            <div id="screen-loading" class="text-center text-yellow-500 animate-pulse">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p class="font-bold">ุฌุงุฑู ุงูุงุชุตุงู ุจุงูููุนุจ...</p>
            </div>

            <div id="screen-banned" class="hidden glass-card p-8 rounded-3xl text-center border-red-600">
                <i class="fas fa-ban text-red-500 text-6xl mb-4"></i>
                <h2 class="text-xl font-bold text-red-500 mb-2">ุชู ุญุธุฑ ุญุณุงุจู!</h2>
                <p class="text-gray-300 text-sm">ููุฏ ุชู ุฅููุงู ุญุณุงุจู ูู ูุจู ุงูุฅุฏุงุฑุฉ ููุฎุงููุฉ ููุงููู ุงูุจุทููุฉ.</p>
            </div>

            <div id="screen-soon" class="hidden glass-card p-8 rounded-3xl text-center border-blue-500">
                <i class="fas fa-clock text-blue-400 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold text-blue-400 mb-2">ุงุณุชุนุฏ ููููุงุฌูุฉ!</h2>
                <p class="text-gray-300 text-sm">ุงูุฌููุฉ ุงููุงุฏูุฉ ูู ุชุจุฏุฃ ุจุนุฏุ ุญุงูุธ ุนูู ุชุฑููุฒู ูุงูุชุธุฑ ุตุงูุฑุฉ ุงูุญูู โฝ๐</p>
            </div>

            <div id="screen-closed" class="hidden glass-card p-8 rounded-3xl text-center border-gray-500">
                <i class="fas fa-lock text-gray-400 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-300 mb-2">ุงูุชูุช ุฌููุฉ ุงูููู</h2>
                <p class="text-gray-400 text-sm">ุชู ุบูู ุงูุฌููุฉ ุงูุญุงููุฉุ ูููุงูู ูู ุงูุชุญุฏู ุงููุงุฏู. ุฑุงุฌุน ุชุฑุชูุจู ูู ุงูููุญุฉ!</p>
            </div>

            <div id="screen-start" class="hidden glass-card p-8 rounded-3xl text-center border-green-500 shadow-[0_0_30px_rgba(34,197,94,0.3)]">
                <i class="fas fa-futbol text-green-400 text-6xl mb-4 animate-bounce"></i>
                <h2 id="active-quiz-title" class="text-2xl font-bold text-green-400 mb-2">ุฌููุฉ ุฌุฏูุฏุฉ</h2>
                <p class="text-gray-300 text-sm mb-6">ูุฏูู 15 ุณุคุงูุ ููุญุงููุฉ ูุงุญุฏุฉ ููุท. ูู ุฃูุช ูุณุชุนุฏ ูููุฒูู ูุฃุฑุถ ุงูููุนุจุ</p>
                <button onclick="startQuiz()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg">
                    ุงุจุฏุฃ ุงูุชุญุฏู ุงูุขู โฝ
                </button>
            </div>

            <div id="screen-playing" class="hidden glass-card p-6 rounded-3xl">
                <div class="flex justify-between items-center mb-4 text-sm font-bold">
                    <span class="text-yellow-500" id="q-counter">ุณุคุงู 1 / 15</span>
                    <span class="text-red-400 flex items-center gap-1"><i class="fas fa-stopwatch"></i> <span id="timer-text">30</span>ุซ</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-2 mb-6 overflow-hidden">
                    <div id="timer-bar" class="bg-yellow-500 h-2 rounded-full w-full"></div>
                </div>
                
                <h3 id="question-text" class="text-lg font-bold text-white mb-6 leading-relaxed text-center min-h-[60px]"></h3>
                
                <div id="options-container" class="space-y-3">
                    </div>
            </div>

            <div id="screen-result" class="hidden glass-card p-8 rounded-3xl text-center border-yellow-500">
                <i class="fas fa-trophy text-yellow-500 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">ุตุงูุฑุฉ ุงูููุงูุฉ!</h2>
                <p class="text-gray-300 mb-6">ููุฏ ุฃูููุช ุงูุชุญุฏูุ ููุฐู ูู ูุญุตูุชู:</p>
                <div class="text-6xl font-black text-yellow-500 mb-6" id="final-score-text">0</div>
                <p class="text-sm text-gray-400 mb-6">ุชู ุฅุฑุณุงู ุฅุฌุงุจุงุชู ุงูุชูุตูููุฉ ููุฅุฏุงุฑุฉ ูุชุณุฌูู ููุงุทู ุจูุฌุงุญ โ</p>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc, collection, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", 
            projectId: "ramadan-87817", 
            appId: "1:343525703258:web:6776b4857425df8bcca263" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. ุงูุชุญูู ูู ูููุฉ ุงููุชุณุงุจู ---
        const localUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!localUser) window.location.href = "index.html";

        // ูุชุบูุฑุงุช ุงููุนุจุฉ
        let quizData = [];
        let quizTitle = "";
        let currentQIndex = 0;
        let sessionScore = 0;
        let detailedResults = []; // ูุชุณุฌูู ุงูุตุญ ูุงูุบูุท [true, false, ...]
        let timerInterval;
        let isAnswering = false;
        let totalUserScore = localUser.score || 0;

        // ุนุฑุถ ุจูุงูุงุช ุงูููุฏุฑ
        document.getElementById('user-name').innerText = localUser.name;
        document.getElementById('user-group').innerText = localUser.group;
        document.getElementById('user-score').innerText = totalUserScore;

        // --- 2. ุงูุชุญูู ูู ุญุงูุฉ ุงููุณุชุฎุฏู ูุญุงูุฉ ุงููููุน ---
        async function initializeDashboard() {
            // ุฌูุจ ุจูุงูุงุช ุงููุชุณุงุจู ุงูุญุงููุฉ (ููุชุฃูุฏ ุฅูู ูุด ูุญุธูุฑ)
            const userRef = doc(db, "users", localUser.id);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists() && userSnap.data().isBanned === true) {
                switchScreen('screen-banned');
                return;
            }

            if (userSnap.exists()) {
                totalUserScore = userSnap.data().score || 0;
                document.getElementById('user-score').innerText = totalUserScore;
            }

            // ุงูุงุณุชูุงุน ูุญุงูุฉ ุงููููุฒ ูู ุงูุฅุฏุงุฑุฉ ูุญุธูุงู
            onSnapshot(doc(db, "settings", "quiz_status"), async (docSnap) => {
                if(docSnap.exists()) {
                    const status = docSnap.data().currentStatus;
                    handleAdminStatus(status);
                }
            });
        }

        async function handleAdminStatus(status) {
            // ูู ูุงู ุจููุนุจ ุฏูููุชูุ ูุชุฎุฑุฌูุด ูู ุงูุดุงุดุฉ!
            if(!document.getElementById('screen-playing').classList.contains('hidden')) return;

            if (status === 'soon') switchScreen('screen-soon');
            else if (status === 'closed' || status === 'saved') switchScreen('screen-closed');
            else if (status === 'active') {
                // ุฌูุจ ุจูุงูุงุช ุงููููุฒ
                const qSnap = await getDoc(doc(db, "settings", "active_quiz_data"));
                if(qSnap.exists()) {
                    quizTitle = qSnap.data().title;
                    quizData = qSnap.data().questions;
                    document.getElementById('active-quiz-title').innerText = quizTitle;
                    
                    // ุงูุชุฃูุฏ ุฅูู ููุนุจููุด ูุจู ูุฏุฉ (ุญูุงูุฉ)
                    if(localStorage.getItem(`played_${quizTitle}`)) {
                        switchScreen('screen-closed');
                        document.querySelector('#screen-closed h2').innerText = "ููุฏ ูุนุจุช ูุฐู ุงูุฌููุฉ ุจุงููุนู!";
                    } else {
                        switchScreen('screen-start');
                    }
                }
            }
        }

        // --- 3. ูุธุงู ุงููุนุจ (ุงููุญุฑู ุงูุฃุณุงุณู) ---
        window.startQuiz = () => {
            currentQIndex = 0;
            sessionScore = 0;
            detailedResults = []; // ุชุตููุฑ ูุตูููุฉ ุงููุชุงุฆุฌ
            switchScreen('screen-playing');
            loadQuestion();
        };

        function loadQuestion() {
            if (currentQIndex >= quizData.length) { endQuiz(); return; }
            
            isAnswering = false;
            const q = quizData[currentQIndex];
            document.getElementById('q-counter').innerText = `ุณุคุงู ${currentQIndex + 1} / ${quizData.length}`;
            document.getElementById('question-text').innerText = q.q;
            
            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full text-right p-4 rounded-xl font-bold text-gray-200 block';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(index, btn);
                optionsDiv.appendChild(btn);
            });

            startTimer();
        }

        function startTimer() {
            let time = 30;
            const timerText = document.getElementById('timer-text');
            const timerBar = document.getElementById('timer-bar');
            
            clearInterval(timerInterval);
            timerText.innerText = time;
            timerBar.style.width = '100%';

            timerInterval = setInterval(() => {
                time--;
                timerText.innerText = time;
                timerBar.style.width = `${(time/30)*100}%`;
                
                if (time <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(-1, null); // ุงูุชูู ุงูููุช = ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ
                }
            }, 1000);
        }

        function checkAnswer(selectedIndex, clickedBtn) {
            if (isAnswering) return;
            isAnswering = true;
            clearInterval(timerInterval);

            const q = quizData[currentQIndex];
            const isCorrect = (selectedIndex === parseInt(q.correctIndex));
            
            // ุชุณุฌูู ูู ุฌุงูุจ ุตุญ ููุง ุบูุท ูููุณุคูู (ูุชุธูุฑ ูู ุงูู Logs)
            detailedResults.push(isCorrect);

            const buttons = document.querySelectorAll('.option-btn');
            
            // ุชูููู ุงูุฅุฌุงุจุงุช
            if (isCorrect) {
                clickedBtn.classList.add('correct');
                sessionScore += 10;
            } else {
                if (clickedBtn) clickedBtn.classList.add('wrong');
                // ุฅุธูุงุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
                if(buttons[parseInt(q.correctIndex)]) {
                    buttons[parseInt(q.correctIndex)].classList.add('correct');
                }
            }

            setTimeout(() => {
                currentQIndex++;
                loadQuestion();
            }, 1500);
        }

        async function endQuiz() {
            switchScreen('screen-result');
            document.getElementById('final-score-text').innerText = sessionScore;
            
            // ุญูุธ ุฅู ุงููุงุนุจ ูุนุจ ุงูุฌููุฉ ุฏู ุนุดุงู ูููุนุจูุงุด ุชุงูู
            localStorage.setItem(`played_${quizTitle}`, "true");

            const userRef = doc(db, "users", localUser.id);
            
            try {
                // 1. ุชุญุฏูุซ ุงูููุงุท ุงูุฅุฌูุงููุฉ
                await updateDoc(userRef, {
                    score: increment(sessionScore),
                    rounds: increment(1)
                });

                // 2. ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงูุชูุตููู ูุฌุฏูู ุงูุฅุฏุงุฑุฉ (Logs)
                await addDoc(collection(userRef, "game_logs"), {
                    day: quizTitle,
                    score: sessionScore,
                    results: detailedResults, // ูุตูููุฉ ุงูู true/false
                    timestamp: serverTimestamp()
                });

                // ุชุญุฏูุซ ุงูุฏุฑุฌุฉ ูู ุงูููุฏุฑ
                totalUserScore += sessionScore;
                document.getElementById('user-score').innerText = totalUserScore;
                
            } catch (e) {
                console.error("ุฎุทุฃ ูู ุญูุธ ุงููุชูุฌุฉ: ", e);
            }
        }

        // ุฏุงูุฉ ุชุจุฏูู ุงูุดุงุดุงุช
        function switchScreen(screenId) {
            const screens = ['screen-loading', 'screen-banned', 'screen-soon', 'screen-closed', 'screen-start', 'screen-playing', 'screen-result'];
            screens.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        // ุชุดุบูู ุงููุธุงู ุนูุฏ ูุชุญ ุงูุตูุญุฉ
        initializeDashboard();

    </script>
</body>
</html>
