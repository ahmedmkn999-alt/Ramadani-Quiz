    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = "index.html";

        document.getElementById('player-name').innerText = currentUser.name;
        document.getElementById('player-group').innerText = currentUser.group;
        document.getElementById('player-score').innerText = currentUser.score || 0;

        let quizData = []; let currentQuestion = 0; let tempScore = 0; let detailedResults = []; let activeDayNum = 0;
        let timerInterval; let timeLeft = 30;
        
        // ┘Е╪к╪║┘К╪▒ ╪з┘Д╪г┘Е╪з┘Ж: ╪╣╪┤╪з┘Ж ┘Ж╪╣╪▒┘Б ┘З┘И ╪и┘К┘Д╪╣╪и ╪п┘Д┘И┘В╪к┘К ┘И┘Д╪з ┘Д╪г
        let isQuizActive = false; 

        window.switchTab = (tabName) => {
            if (isQuizActive) {
                alert("тЪая╕П ┘Д╪з ┘К┘Е┘Г┘Ж┘Г ╪з┘Д╪к┘Ж┘В┘Д ╪и┘К┘Ж ╪з┘Д╪╡┘Б╪н╪з╪к ╪г╪л┘Ж╪з╪б ╪г╪п╪з╪б ╪з┘Д╪з╪о╪к╪и╪з╪▒!");
                return;
            }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-${tabName}`).classList.add('active');
            if(tabName === 'leaderboard') loadGroupLeaderboard();
        };

        async function loadGroupLeaderboard() {
            const listDiv = document.getElementById('group-list');
            try {
                const q = query(collection(db, "users"), where("group", "==", currentUser.group));
                const snap = await getDocs(q);
                let members = []; snap.forEach(d => members.push(d.data()));
                members.sort((a,b) => (b.score || 0) - (a.score || 0));
                
                listDiv.innerHTML = '';
                members.forEach((m, index) => {
                    let rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-700' : 'text-gray-500';
                    let isMe = m.name === currentUser.name ? 'border-2 border-yellow-600 bg-gray-800 transform scale-105 my-2 shadow-lg' : 'bg-gray-900 border border-gray-800';
                    listDiv.innerHTML += `<div class="flex justify-between items-center p-4 rounded-xl transition ${isMe}"><div class="flex items-center gap-4"><span class="font-black text-lg ${rankColor}">${index + 1}</span><span class="font-bold text-sm ${m.name === currentUser.name ? 'text-white' : 'text-gray-300'}">${m.name}</span></div><span class="font-black text-yellow-500 text-lg">${m.score || 0}</span></div>`;
                });
            } catch(e) { listDiv.innerHTML = '<p class="text-center text-red-500 text-xs">╪о╪╖╪г ┘Б┘К ╪м┘Д╪и ╪з┘Д╪к╪▒╪к┘К╪и</p>'; }
        }

        onSnapshot(doc(db, "settings", "global_status"), async (docSnap) => {
            const container = document.getElementById('quiz-container');
            if (!docSnap.exists()) return;
            
            const globalData = docSnap.data();
            const status = globalData.status;
            activeDayNum = globalData.currentDay;
            const expiryTime = globalData.expiryTime;

            if (expiryTime && Date.now() > expiryTime) {
                if(isQuizActive) { isQuizActive = false; clearInterval(timerInterval); endQuiz(); return; }
                container.innerHTML = `<div class="ramadan-card p-8 text-center shadow-2xl border-t-4 border-red-500"><i class="fas fa-hourglass-end text-6xl text-red-500 mb-6 animate-pulse"></i><h2 class="text-2xl font-black text-white mb-2">╪з┘Ж╪к┘З┘Й ┘И┘В╪к ╪з┘Д╪м┘И┘Д╪й!</h2><p class="text-gray-300 text-sm leading-relaxed mb-6">┘Д┘В╪п ╪з┘Ж╪к┘З┘Й ╪з┘Д┘И┘В╪к ╪з┘Д┘Е╪н╪п╪п ┘Д┘Д╪е╪м╪з╪и╪й ╪╣┘Д┘Й ╪м┘И┘Д╪й ╪з┘Д┘К┘И┘Е (${activeDayNum}).</p><button onclick="switchTab('leaderboard')" class="bg-gray-800 text-white font-bold py-3 px-6 rounded-xl border border-gray-600">╪┤╪з┘З╪п ╪з┘Д╪к╪▒╪к┘К╪и</button></div>`;
                return;
            }

            const userSnap = await getDoc(doc(db, "users", currentUser.id));
            if(userSnap.exists()) {
                currentUser = { id: userSnap.id, ...userSnap.data() };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score || 0;
            }

            if (status === 'closed') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-red-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-red-500"><i class="fas fa-lock text-3xl text-red-400"></i></div><h2 class="text-xl font-bold text-white mb-2">╪з┘Д╪║╪▒┘Б╪й ┘Е╪║┘Д┘В╪й</h2><p class="text-gray-400 text-sm">╪к┘Е ╪е╪║┘Д╪з┘В ╪з┘Д┘Д╪╣╪и ┘Е┘Ж ┘В┘Р╪и┘Д ╪з┘Д╪е╪п╪з╪▒╪й ┘Е╪д┘В╪к╪з┘Л.</p></div>`;
                return;
            }

            if (status === 'soon') {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-blue-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-blue-500"><i class="fas fa-clock text-3xl text-blue-400"></i></div><h2 class="text-xl font-bold text-white mb-2">╪м┘И┘Д╪й ╪з┘Д┘К┘И┘Е (${activeDayNum})</h2><p class="text-gray-400 text-sm">╪з┘Д╪к╪н╪п┘К ┘Д┘Е ┘К╪и╪п╪г ╪и╪╣╪п.. ╪з╪│╪к╪╣╪п┘И╪з!</p></div>`;
                return;
            }

            if (currentUser.lastPlayedDay === activeDayNum) {
                container.innerHTML = `<div class="ramadan-card p-8 text-center"><div class="bg-green-900/50 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 border-2 border-green-500"><i class="fas fa-check-circle text-4xl text-green-400"></i></div><h2 class="text-xl font-bold text-white mb-2">╪г┘Ж╪к ╪г┘Ж┘З┘К╪к ╪м┘И┘Д╪й ╪з┘Д┘К┘И┘Е ╪и┘Ж╪м╪з╪н!</h2><p class="text-gray-400 text-sm leading-relaxed">┘Д┘В╪п ╪г┘Г┘Е┘Д╪к ╪г╪│╪ж┘Д╪й ╪з┘Д┘К┘И┘Е (${activeDayNum}).<br>╪▒╪з╪м╪╣ ╪к╪▒╪к┘К╪и ┘Е╪м┘Е┘И╪╣╪к┘Г ┘И╪з┘Ж╪к╪╕╪▒┘Ж╪з ╪║╪п╪з┘Л!</p></div>`;
                return;
            }

            if (status === 'active' && !isQuizActive) showStartScreen();
        });

        function showStartScreen() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-8 text-center w-full shadow-2xl transform transition hover:scale-105"><div class="bg-gradient-to-br from-yellow-500 to-yellow-700 w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner border-4 border-gray-900"><i class="fas fa-play text-4xl text-black ml-2"></i></div><h2 class="text-2xl font-black text-white mb-3">╪к╪н╪п┘К ╪з┘Д┘К┘И┘Е (${activeDayNum})</h2><p class="text-gray-300 text-sm mb-6 leading-relaxed bg-gray-900/50 p-3 rounded-lg border border-gray-800"><i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> ┘Д╪п┘К┘Г 30 ╪л╪з┘Ж┘К╪й ┘Д┘Г┘Д ╪│╪д╪з┘Д.<br><span class="text-red-400 font-bold">╪к┘Ж╪и┘К┘З:</span> ╪з┘Д╪о╪▒┘И╪м ┘Е┘Ж ╪з┘Д╪╡┘Б╪н╪й ╪г┘И ╪к╪и╪п┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В ╪│┘К╪д╪п┘К ┘Д╪е┘Ж┘З╪з╪б ╪з┘Д╪з╪о╪к╪и╪з╪▒ ┘Б┘И╪▒╪з┘Л!</p><button onclick="startQuizForDay(${activeDayNum})" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-black py-4 rounded-xl shadow-[0_0_15px_rgba(184,134,11,0.4)] text-lg transition active:scale-95">╪п╪о┘И┘Д ╪з┘Д┘Е┘Д╪╣╪и ┘И╪и╪п╪б ╪з┘Д╪к╪н╪п┘К</button></div>`;
        }

        window.startQuizForDay = async (dayNumber) => {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-10 text-center"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-4"></i><p class="font-bold animate-pulse">╪м╪з╪▒┘К ╪к╪м┘З┘К╪▓ ╪з┘Д╪г╪│╪ж┘Д╪й...</p></div>`;
            try {
                const daySnap = await getDoc(doc(db, "quizzes_pool", `day_${dayNumber}`));
                if (daySnap.exists() && daySnap.data().variations && daySnap.data().variations.length > 0) {
                    const variations = daySnap.data().variations;
                    quizData = variations[Math.floor(Math.random() * variations.length)].questions;
                    currentQuestion = 0; tempScore = 0; detailedResults = []; 
                    
                    // ╪к┘Б╪╣┘К┘Д ╪з┘Д╪г┘Е╪з┘Ж
                    isQuizActive = true; 
                    
                    showQuestion();
                } else {
                    container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-400"><i class="fas fa-times-circle text-4xl mb-4"></i><p>╪╣╪░╪▒╪з┘Л╪М ┘Д┘Е ╪к┘В┘Е ╪з┘Д╪е╪п╪з╪▒╪й ╪и╪▒┘Б╪╣ ╪г╪│╪ж┘Д╪й ╪з┘Д┘К┘И┘Е ╪и╪╣╪п.</p></div>`;
                }
            } catch (e) { console.error(e); }
        };

        // ==========================================
        // ЁЯЪи ┘Ж╪╕╪з┘Е ╪з┘Д╪г┘Е╪з┘Ж ┘И┘Е┘Г╪з┘Б╪н╪й ╪з┘Д╪║╪┤ ЁЯЪи
        // ==========================================
        
        // 1. ╪╣┘Ж╪п ╪к╪и╪п┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В ╪г┘И ╪к┘Ж╪▓┘К┘Д ╪з┘Д┘Е╪к╪╡┘Б╪н
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && isQuizActive) {
                alert("ЁЯЪл ╪к╪н╪░┘К╪▒ ╪г┘Е┘Ж┘К: ┘Д┘В╪п ┘В┘Е╪к ╪и╪з┘Д╪о╪▒┘И╪м ┘Е┘Ж ┘Ж╪з┘Б╪░╪й ╪з┘Д╪з╪о╪к╪и╪з╪▒!\n╪к┘Е ╪е┘Ж┘З╪з╪б ╪з┘Д╪м┘И┘Д╪й ┘Б┘И╪▒╪з┘Л ┘Д┘Е┘Ж╪╣ ╪з┘Д╪║╪┤╪М ┘И╪│┘К╪к┘Е ╪н┘Б╪╕ ┘Ж╪к┘К╪м╪к┘Г ╪з┘Д╪н╪з┘Д┘К╪й.");
                isQuizActive = false;
                clearInterval(timerInterval);
                endQuiz();
            }
        });

        // 2. ╪╣┘Ж╪п ┘Е╪н╪з┘И┘Д╪й ╪з┘Д╪▒╪м┘И╪╣ ┘Д┘Д╪о┘Д┘Б (Back Button)
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
            if (isQuizActive) {
                const warning = confirm("тЪая╕П ╪к╪н╪░┘К╪▒: ╪з┘Д╪▒╪м┘И╪╣ ┘Д┘Д╪о┘Д┘Б ╪│┘К╪д╪п┘К ╪е┘Д┘Й ╪е┘Ж┘З╪з╪б ╪з┘Д╪з╪о╪к╪и╪з╪▒ ┘Б┘И╪▒╪з┘Л! ┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п╪Я");
                if (warning) {
                    isQuizActive = false;
                    clearInterval(timerInterval);
                    endQuiz();
                } else {
                    window.history.pushState(null, null, window.location.href); // ╪е┘Д╪║╪з╪б ╪з┘Д╪▒╪м┘И╪╣
                }
            } else {
                window.history.back(); // ┘Д┘И ┘Е╪┤ ╪и┘К┘Д╪╣╪и╪М ┘К╪▒╪м╪╣ ╪╣╪з╪п┘К
            }
        };

        // 3. ╪╣┘Ж╪п ┘Е╪н╪з┘И┘Д╪й ╪к╪н╪п┘К╪л ╪г┘И ╪е╪║┘Д╪з┘В ╪з┘Д╪╡┘Б╪н╪й
        window.addEventListener("beforeunload", (e) => {
            if (isQuizActive) {
                e.preventDefault();
                e.returnValue = "╪з┘Д╪о╪▒┘И╪м ╪з┘Д╪в┘Ж ╪│┘К╪д╪п┘К ┘Д╪е┘Ж┘З╪з╪б ╪з┘Д┘Г┘И┘К╪▓ ╪и╪з┘Д╪п╪▒╪м╪й ╪з┘Д╪н╪з┘Д┘К╪й!";
                return e.returnValue;
            }
        });
        // ==========================================

        function showQuestion() {
            if (currentQuestion >= quizData.length) return endQuiz();
            const q = quizData[currentQuestion];
            let html = `<div class="ramadan-card p-6 w-full shadow-2xl"><div class="flex justify-between items-center mb-5 text-xs font-bold text-gray-400 border-b border-gray-700 pb-3"><span class="bg-gray-800 px-3 py-1 rounded-lg">╪з┘Д┘К┘И┘Е ${activeDayNum}</span><span class="text-yellow-500 bg-yellow-900/30 px-3 py-1 rounded-lg">╪│╪д╪з┘Д ${currentQuestion + 1} / ${quizData.length}</span></div><div class="w-full bg-gray-900 h-3 rounded-full mb-6 overflow-hidden border border-gray-700 p-0.5"><div id="timer-bar" class="h-full bg-green-500 w-full rounded-full"></div></div><div class="text-center mb-6"><span id="timer-text" class="text-3xl font-black text-white drop-shadow-md">30</span></div><h2 class="text-xl md:text-2xl font-bold mb-8 text-center leading-relaxed text-white drop-shadow-md">${q.q}</h2><div class="space-y-3">`;
            q.options.forEach((opt, index) => { html += `<button onclick="handleAnswer(${index})" class="option-btn w-full text-right p-5 rounded-xl font-bold text-sm md:text-base text-gray-200 shadow-md">${opt}</button>`; });
            html += `</div></div>`;
            document.getElementById('quiz-container').innerHTML = html;
            startTimer();
        }

        function startTimer() {
            timeLeft = 30; const timerBar = document.getElementById('timer-bar'); const timerText = document.getElementById('timer-text');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--; timerText.innerText = timeLeft;
                timerBar.style.width = ((timeLeft / 30) * 100) + '%';
                if(timeLeft <= 10) timerBar.classList.replace('bg-green-500', 'bg-red-500'); else if(timeLeft <= 20) timerBar.classList.replace('bg-green-500', 'bg-yellow-500');
                if (timeLeft <= 0) { clearInterval(timerInterval); handleAnswer(-1); }
            }, 1000);
        }

        window.handleAnswer = (selectedIndex) => {
            clearInterval(timerInterval);
            detailedResults.push(selectedIndex === quizData[currentQuestion].correctIndex);
            if (selectedIndex === quizData[currentQuestion].correctIndex) tempScore += 1;
            currentQuestion++; showQuestion();
        };

        async function endQuiz() {
            isQuizActive = false; // ╪е┘К┘В╪з┘Б ╪н╪з┘Д╪й ╪з┘Д╪г┘Е╪з┘Ж ╪╣╪┤╪з┘Ж ┘К╪╣╪▒┘Б ┘К╪к┘Ж┘В┘Д ┘Б┘К ╪з┘Д┘Е┘И┘В╪╣
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="ramadan-card p-12 text-center shadow-2xl"><i class="fas fa-spinner fa-spin text-5xl text-yellow-500 mb-6"></i><p class="font-bold text-lg animate-pulse">╪м╪з╪▒┘К ╪▒╪╡╪п ╪п╪▒╪м╪з╪к┘Г ┘Б┘К ╪з┘Д╪│┘К╪▒┘Б╪▒...</p></div>`;
            try {
                const userRef = doc(db, "users", currentUser.id);
                await updateDoc(userRef, { score: increment(tempScore), lastPlayedDay: activeDayNum });
                await addDoc(collection(userRef, "game_logs"), { day: activeDayNum, score: tempScore, results: detailedResults, timestamp: serverTimestamp() });
                currentUser.score = (currentUser.score || 0) + tempScore; currentUser.lastPlayedDay = activeDayNum; localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('player-score').innerText = currentUser.score;
                container.innerHTML = `<div class="ramadan-card p-8 text-center shadow-2xl border-t-4 border-yellow-500"><i class="fas fa-trophy text-7xl text-yellow-500 mb-6 drop-shadow-lg"></i><h2 class="text-3xl font-black text-white mb-2">╪з┘Ж╪к┘З╪к ╪з┘Д┘Е╪╣╪▒┘Г╪й!</h2><p class="text-gray-400 mb-6 text-sm">╪к┘Е ╪к╪│╪м┘К┘Д ┘Ж╪к┘К╪м╪к┘Г ┘Д┘Д┘К┘И┘Е (${activeDayNum}) ╪и┘Ж╪м╪з╪н</p><div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 mb-8 shadow-inner"><p class="text-sm text-gray-500 mb-2 font-bold">╪з┘Д┘Ж┘В╪з╪╖ ╪з┘Д╪к┘К ╪н╪╡╪п╪к┘З╪з ╪з┘Д┘К┘И┘Е</p><p class="text-5xl font-black text-yellow-500 drop-shadow-md">${tempScore} <span class="text-lg text-gray-600">/ ${quizData.length}</span></p></div><button onclick="switchTab('leaderboard')" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold py-4 rounded-xl shadow-lg transition text-lg"><i class="fas fa-list-ol ml-2"></i> ╪┤╪з┘З╪п ╪к╪▒╪к┘К╪и ┘Е╪м┘Е┘И╪╣╪к┘Г</button></div>`;
            } catch(e) { container.innerHTML = `<div class="ramadan-card p-8 text-center text-red-500 border-t-4 border-red-500"><i class="fas fa-wifi text-4xl mb-4"></i><p class="font-bold">╪о╪╖╪г ┘Б┘К ╪з┘Д╪┤╪и┘Г╪й!</p></div>`; }
        }

        document.getElementById('logout-btn').addEventListener('click', () => { 
            if (isQuizActive) {
                alert("┘Д╪з ┘К┘Е┘Г┘Ж┘Г ╪к╪│╪м┘К┘Д ╪з┘Д╪о╪▒┘И╪м ╪г╪л┘Ж╪з╪б ╪з┘Д╪з╪о╪к╪и╪з╪▒!");
                return;
            }
            localStorage.clear(); window.location.href = "index.html"; 
        });
    </script>
