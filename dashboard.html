<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>كويز الرمضاني | لوحة المتسابق</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { background-color: #050a15; color: white; font-family: 'Cairo', sans-serif; background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); overflow-x: hidden; }
        .ramadan-card { background: rgba(13, 27, 42, 0.95); border: 1px solid #b8860b; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .tab-btn { transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #d4af37); color: #000; font-weight: 900; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        .option-btn { background: #112240; border: 1px solid #233f78; transition: all 0.2s; }
        .option-btn:active { transform: scale(0.95); background: #b8860b; color: black; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 pb-10">

    <div class="flex justify-between items-center w-full max-w-lg mx-auto mb-2">
        <button id="logout-btn" class="text-red-400 bg-red-900/20 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-red-900/50 border border-red-900">
            <i class="fas fa-sign-out-alt ml-1"></i> تسجيل خروج
        </button>
        <div></div>
    </div>

    <div class="flex justify-center mb-4">
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-24 h-24 object-contain rounded-full border-2 border-yellow-600 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="ramadan-card flex justify-between items-center p-4 rounded-2xl mb-6 w-full max-w-lg mx-auto">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-2xl text-black"></i>
            </div>
            <div>
                <h2 id="player-name" class="font-bold text-white text-md">...</h2>
                <p id="player-group" class="text-xs text-yellow-500 font-bold">...</p>
            </div>
        </div>
        <div class="text-center bg-gray-900 p-2 rounded-xl border border-gray-700 min-w-[70px]">
            <p class="text-[10px] text-gray-400">إجمالي النقاط</p>
            <p id="player-score" class="font-black text-xl text-yellow-500">0</p>
        </div>
    </header>

    <div class="flex bg-gray-900 rounded-xl p-1 mb-6 max-w-lg mx-auto w-full border border-gray-800">
        <button id="btn-arena" class="tab-btn active flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-futbol"></i> الملعب</button>
        <button id="btn-leaderboard" class="tab-btn flex-1 py-3 text-sm rounded-lg text-gray-400 font-bold"><i class="fas fa-trophy"></i> مجموعتي</button>
    </div>

    <main id="tab-arena" class="tab-content active flex-grow flex flex-col items-center w-full max-w-lg mx-auto">
        <div id="quiz-container" class="w-full">
            <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>جاري تحميل الملعب...</p></div>
        </div>
    </main>

    <main id="tab-leaderboard" class="tab-content flex-grow w-full max-w-lg mx-auto">
        <div class="ramadan-card p-5 rounded-2xl">
            <h3 class="text-yellow-500 font-bold mb-4 text-center border-b border-gray-700 pb-2">فرسان مجموعتك</h3>
            <div id="group-list" class="space-y-2"></div>
        </div>
    </main>

    <div class="mt-auto pt-8 flex justify-center gap-6">
        <a href="https://www.facebook.com/share/1GmFwuYWZv/" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white border border-gray-700"><i class="fab fa-facebook text-xl"></i></a>
        <a href="https://chat.whatsapp.com/D5dKR9EdHZjDPgrFpHl28J" target="_blank" class="bg-gray-800 p-3 rounded-full text-gray-400 hover:text-white border border-gray-700"><i class="fab fa-whatsapp text-xl"></i></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = "index.html";

        document.getElementById('player-name').innerText = currentUser.name;
        document.getElementById('player-group').innerText = currentUser.group;
        document.getElementById('player-score').innerText = currentUser.score || 0;

        let quizData = []; let currentQuestion = 0; let score = 0; let isQuizActive = false;
        let timerInterval; let timeLeft = 30;

        // تبديل الصفحات
        document.getElementById('btn-arena').onclick = () => switchTab('arena');
        document.getElementById('btn-leaderboard').onclick = () => { switchTab('leaderboard'); loadLeaderboard(); };

        function switchTab(t) {
            if(isQuizActive) return alert("بلاش غش! خلص الكويز الأول");
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.getElementById('btn-'+t).classList.add('active');
        }

        // الاستماع لحالة الموقع (تصليح الوصلة)
        onSnapshot(doc(db, "settings", "quiz_status"), (s) => {
            const container = document.getElementById('quiz-container');
            if (!s.exists()) return;
            const status = s.data().currentStatus;

            if (status === 'closed') container.innerHTML = `<div class="ramadan-card p-8 text-center w-full"><i class="fas fa-lock text-5xl text-red-500 mb-4"></i><h2 class="text-xl">الجولة مغلقة</h2></div>`;
            else if (status === 'soon') container.innerHTML = `<div class="ramadan-card p-8 text-center w-full"><i class="fas fa-clock text-5xl text-blue-500 mb-4"></i><h2 class="text-xl">الجولة قريباً</h2></div>`;
            else if (status === 'active') loadQuiz();
            else container.innerHTML = `<div class="ramadan-card p-8 text-center w-full">جاري التجهيز...</div>`;
        });

        async function loadQuiz() {
            const snap = await getDoc(doc(db, "settings", "active_quiz_data"));
            if (snap.exists()) {
                quizData = snap.data().questions;
                currentQuestion = 0; score = 0;
                document.getElementById('quiz-container').innerHTML = `
                    <div class="ramadan-card p-8 text-center w-full">
                        <i class="fas fa-play-circle text-6xl text-yellow-500 mb-4"></i>
                        <h2 class="text-2xl font-bold mb-4">${snap.data().title}</h2>
                        <button id="start-quiz" class="w-full bg-yellow-600 py-3 rounded-xl font-bold text-black">ابدأ الآن</button>
                    </div>`;
                document.getElementById('start-quiz').onclick = () => { isQuizActive = true; showQuestion(); };
            }
        }

        function showQuestion() {
            if (currentQuestion >= quizData.length) return endQuiz();
            const q = quizData[currentQuestion];
            document.getElementById('quiz-container').innerHTML = `
                <div class="ramadan-card p-6 w-full">
                    <div class="flex justify-between text-xs text-gray-400 mb-4 border-b border-gray-700 pb-2">
                        <span>سؤال ${currentQuestion + 1} من ${quizData.length}</span>
                        <span id="timer-text" class="text-yellow-500 font-bold">30</span>
                    </div>
                    <div class="w-full bg-gray-800 h-2 rounded mb-6 overflow-hidden"><div id="timer-bar" class="h-full bg-green-500 w-full"></div></div>
                    <h2 class="text-xl text-center mb-8">${q.q}</h2>
                    <div class="space-y-3" id="options"></div>
                </div>`;
            
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-right p-4 rounded-xl font-bold text-sm";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(i);
                document.getElementById('options').appendChild(btn);
            });
            startTimer();
        }

        function startTimer() {
            timeLeft = 30; clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-text').innerText = timeLeft;
                document.getElementById('timer-bar').style.width = (timeLeft/30*100)+'%';
                if(timeLeft <= 0) { clearInterval(timerInterval); handleAnswer(-1); }
            }, 1000);
        }

        function handleAnswer(i) {
            clearInterval(timerInterval);
            if(i === quizData[currentQuestion].correctIndex) score++;
            currentQuestion++;
            showQuestion();
        }

        async function endQuiz() {
            isQuizActive = false;
            const qc = document.getElementById('quiz-container');
            qc.innerHTML = "جاري الحفظ...";
            await updateDoc(doc(db, "users", currentUser.id), { score: increment(score) });
            currentUser.score += score;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.getElementById('player-score').innerText = currentUser.score;
            qc.innerHTML = `<div class="ramadan-card p-8 text-center border-t-4 border-yellow-500">
                <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                <h2 class="text-2xl mb-2">عاش يا بطل!</h2>
                <p class="text-3xl font-black text-yellow-500 mb-6">${score} / ${quizData.length}</p>
                <button onclick="location.reload()" class="w-full bg-gray-800 p-3 rounded-xl">العودة</button>
            </div>`;
        }

        async function loadLeaderboard() {
            const list = document.getElementById('group-list');
            list.innerHTML = "تحميل...";
            const q = query(collection(db, "users"), where("group", "==", currentUser.group));
            const snap = await getDocs(q);
            let members = []; snap.forEach(d => members.push(d.data()));
            members.sort((a,b) => (b.score||0) - (a.score||0));
            list.innerHTML = members.map((m, i) => `
                <div class="flex justify-between p-3 rounded-xl ${m.name===currentUser.name?'bg-yellow-900/30 border border-yellow-600':'bg-gray-900'}">
                    <span>${i+1}. ${m.name}</span>
                    <span class="font-bold text-yellow-500">${m.score||0}</span>
                </div>`).join('');
        }

        document.getElementById('logout-btn').onclick = () => { localStorage.clear(); window.location.href="index.html"; };

        // أمان مكافحة الغش
        document.addEventListener("visibilitychange", () => { if (document.hidden && isQuizActive) { alert("تم إنهاء الاختبار لخروجك من الصفحة!"); location.reload(); } });
    </script>
</body>
</html>
