<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù„Ø¹Ø¨ Ø±Ù…Ø¶Ø§Ù† | Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ÙƒØ¨Ø±</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { background-color: #030712; color: white; font-family: 'Cairo', sans-serif; background-image: radial-gradient(circle at top right, #112240, #030712); background-attachment: fixed; overflow-x: hidden; }
        .glass-card { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(212, 175, 55, 0.2); backdrop-filter: blur(12px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .gold-text { background: linear-gradient(to right, #ffd700, #d4af37, #ffdf00); -webkit-background-clip: text; color: transparent; }
        .tab-btn { transition: 0.4s; cursor: pointer; }
        .tab-btn.active { background: linear-gradient(90deg, #b8860b, #ffd700); color: #000; font-weight: 900; transform: scale(1.02); }
        .day-active { border: 2px solid #ffd700; background: linear-gradient(145deg, rgba(212,175,55,0.1), rgba(0,0,0,0.8)); animation: neonPulse 2s infinite; }
        @keyframes neonPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        #quiz-overlay { position: fixed; inset: 0; background: rgba(3, 7, 18, 0.98); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .quiz-box { width: 100%; max-width: 500px; background: rgba(17, 24, 39, 0.9); border: 2px solid #b8860b; border-radius: 30px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .opt-btn { background: #1e293b; border: 1px solid #334155; transition: all 0.2s; width: 100%; text-align: right; padding: 18px; border-radius: 16px; font-weight: bold; margin-bottom: 12px; font-size: 15px; color: #e2e8f0; }
        .opt-btn:active { background: #b8860b; color: black; transform: scale(0.95); }
        #timer-bar { transition: width 1s linear, background-color 0.3s; }
        .danger-pulse { animation: heartbeat 0.8s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="p-4 pb-24">

    <div id="champ-flying-popup" class="fixed inset-0 z-[5000] flex items-center justify-center bg-black/80 backdrop-blur-md transition-opacity duration-700" style="display:none; opacity: 0;">
        <div id="champ-popup-card" class="bg-gradient-to-b from-yellow-600 to-yellow-900 p-1 rounded-3xl shadow-[0_0_50px_rgba(212,175,55,0.8)] transform scale-50 transition-transform duration-700 w-11/12 max-w-sm">
            <div class="bg-gray-900 rounded-[22px] p-8 text-center border border-yellow-500/50 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-500 rounded-full blur-[50px] opacity-30"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-yellow-600 rounded-full blur-[50px] opacity-30"></div>
                
                <i class="fas fa-crown text-7xl text-yellow-400 mb-6 drop-shadow-md animate-bounce relative z-10"></i>
                <h2 class="text-3xl font-black text-white mb-2 relative z-10">ØªØ­ÙŠØ© Ù„Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ…!</h2>
                <div class="bg-black/40 p-4 rounded-2xl border border-yellow-700/50 relative z-10 mt-4">
                    <p id="champ-popup-text" class="text-yellow-400 font-bold text-xl leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="daily-msg-box" class="max-w-lg mx-auto bg-gradient-to-r from-blue-900/50 to-purple-900/50 border border-blue-500/50 p-4 rounded-2xl mb-4 text-center text-sm text-blue-200 hidden shadow-lg font-bold"></div>

    <div class="flex justify-between items-center max-w-lg mx-auto mb-6">
        <button onclick="window.logoutUser()" class="bg-gray-800/80 text-red-400 border border-red-900/50 px-5 py-2 rounded-xl text-xs font-black shadow-lg"><i class="fas fa-power-off ml-1"></i> Ø®Ø±ÙˆØ¬</button>
        <img src="https://i.postimg.cc/9Fpp5TVC/IMG-20260217-031514.png" class="w-14 h-14 rounded-full border-2 border-yellow-500 shadow-[0_0_15px_rgba(184,134,11,0.5)]">
    </div>

    <header class="glass-card p-6 rounded-3xl mb-8 max-w-lg mx-auto relative overflow-hidden">
        <div class="flex justify-between items-center relative z-10">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-yellow-400 to-yellow-700 w-14 h-14 rounded-2xl flex items-center justify-center text-black shadow-inner transform rotate-3"><i class="fas fa-shield-alt text-2xl"></i></div>
                <div>
                    <h2 id="p-name" class="font-black text-white text-lg">...</h2>
                    <p class="text-xs mt-1"><span id="p-group" class="text-yellow-500 font-bold bg-yellow-900/40 px-3 py-1 rounded-lg border border-yellow-700/50">...</span></p>
                </div>
            </div>
            <div class="text-center">
                <p class="text-[10px] text-gray-400 font-bold mb-1">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                <p id="p-score" class="font-black text-3xl gold-text">0</p>
            </div>
        </div>
        <div class="mt-5 relative z-10">
            <div class="flex justify-between text-[10px] text-gray-400 mb-1 font-bold">
                <span>ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø©</span><span id="progress-text" class="text-yellow-500">0 / 29 Ø¬ÙˆÙ„Ø©</span>
            </div>
            <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400" style="width: 0%;"></div></div>
        </div>
    </header>

    <div class="flex bg-gray-800/80 p-1.5 rounded-2xl mb-8 max-w-lg mx-auto border border-gray-700 shadow-xl">
        <button onclick="window.showTab('arena')" id="btn-arena" class="tab-btn active flex-1 py-3.5 text-sm rounded-xl font-bold">Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ—ºï¸</button>
        <button onclick="window.showTab('leaderboard')" id="btn-leader" class="tab-btn flex-1 py-3.5 text-sm rounded-xl font-bold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ğŸ†</button>
    </div>

    <div id="view-arena" class="max-w-lg mx-auto space-y-4 pb-10"><div class="text-center p-10"><i class="fas fa-spinner fa-spin text-yellow-500 text-4xl"></i></div></div>

    <div id="view-leaderboard" class="max-w-lg mx-auto hidden pb-10">
        <div id="overall-champion" class="mb-6"></div>
        <div class="glass-card p-6 rounded-3xl">
            <h3 class="text-center text-white font-black mb-6 text-lg border-b border-gray-700 pb-3">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ</h3>
            <div id="group-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="quiz-overlay"><div class="quiz-box" id="quiz-content"></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let user = null;
        try { user = JSON.parse(localStorage.getItem('currentUser')); if (!user) throw new Error(); } 
        catch(e) { window.location.replace("index.html"); }

        document.getElementById('p-name').innerText = user.name || "Ù…Ø³ØªØ®Ø¯Ù…";
        document.getElementById('p-group').innerText = (user.group || "") + " | " + (user.team || "");
        document.getElementById('p-score').innerText = user.score || 0;

        let myLogs = {}, adminDay = 1, adminStatus = "closed", qList = [], curIdx = 0, curSc = 0, timer, isQuizActive = false;

        function init() {
            // ğŸŸ¢ 1. Ø¬Ù„Ø¨ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ù„ Ø§Ù„Ø·Ø§Ø¦Ø±Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ğŸŸ¢
            db.collection("settings").doc("champData").get().then(s => {
                if(s.exists && s.data().message && s.data().message.trim() !== "") {
                    // Ø¹Ø´Ø§Ù† Ù…ØªØ¸Ù‡Ø±Ø´ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³ ÙÙŠ ÙƒÙ„ Ø¬Ù„Ø³Ø© Ø¯Ø®ÙˆÙ„ (Ø¹Ø´Ø§Ù† Ù…ØªØ²Ù‡Ù‚ÙˆØ´ ÙƒÙ„ Ù…Ø§ ÙŠÙØªØ­ ØµÙØ­Ø©)
                    if(!sessionStorage.getItem('champSeen')) {
                        let pop = document.getElementById('champ-flying-popup');
                        let card = document.getElementById('champ-popup-card');
                        document.getElementById('champ-popup-text').innerText = s.data().message;
                        pop.style.display = 'flex';
                        
                        // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
                        requestAnimationFrame(() => {
                            pop.style.opacity = '1';
                            card.classList.remove('scale-50');
                            card.classList.add('scale-100');
                            if(typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.3 }, zIndex: 6000 });
                        });

                        // Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 3.5 Ø«ÙˆØ§Ù†ÙŠ
                        setTimeout(() => {
                            pop.style.opacity = '0';
                            card.classList.remove('scale-100');
                            card.classList.add('scale-50');
                            setTimeout(() => { pop.style.display = 'none'; }, 700);
                            sessionStorage.setItem('champSeen', 'true');
                        }, 3500);
                    }
                }
            });

            // 2. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
            db.collection("settings").doc("dailyData").get().then(s => {
                if(s.exists && s.data().message && s.data().message.trim() !== "") {
                    let b = document.getElementById('daily-msg-box');
                    b.innerText = s.data().message; b.classList.remove('hidden');
                }
            });

            db.collection("users").doc(user.id).onSnapshot(doc => {
                if(!doc.exists) return window.logoutUser();
                let d = doc.data(); 
                if(d.isBanned) { alert("â›” ØªÙ… Ø­Ø¸Ø±Ùƒ!"); window.logoutUser(); }
                document.getElementById('p-score').innerText = d.score || 0;
            });

            db.collection("users").doc(user.id).collection("game_logs").get().then(snap => {
                snap.forEach(d => myLogs[d.data().day] = d.data().score);
                let pCount = Object.keys(myLogs).length;
                document.getElementById('progress-text').innerText = `${pCount} / 29 Ø¬ÙˆÙ„Ø©`;
                document.getElementById('progress-bar').style.width = `${(pCount/29)*100}%`;

                db.collection("settings").doc("global_status").onSnapshot(doc => {
                    if(doc.exists) { adminDay = doc.data().currentDay; adminStatus = doc.data().status; }
                    renderMap();
                });
            });
        }

        function renderMap() {
            let container = document.getElementById('view-arena'); let html = '';
            for (let i = 1; i <= 29; i++) {
                let isPlayed = myLogs[i] !== undefined; let isActive = (i === adminDay && adminStatus === 'active'); let isSoon = (i === adminDay && adminStatus === 'soon');
                if (isPlayed) html += `<div class="glass-card p-5 rounded-2xl flex justify-between opacity-70 border-l-4 border-l-green-500"><div class="flex items-center gap-4"><div class="bg-green-500/20 text-green-400 w-12 h-12 rounded-full flex justify-center items-center"><i class="fas fa-check"></i></div><div><p class="font-bold text-gray-300">Ø§Ù„Ø¬ÙˆÙ„Ø© ${i}</p><p class="text-xs text-green-400 mt-1">Ù…ÙƒØªÙ…Ù„Ø©</p></div></div><p class="font-black text-2xl text-yellow-500">${myLogs[i]}</p></div>`;
                else if (isActive) html += `<div onclick="window.openQuiz(${i})" class="day-box day-active p-6 rounded-2xl flex justify-between cursor-pointer"><div class="flex items-center gap-4"><div class="bg-yellow-500 w-14 h-14 rounded-full flex justify-center items-center text-black"><i class="fas fa-play text-2xl ml-1"></i></div><div><p class="font-black text-white text-xl">Ø§Ù„Ø¬ÙˆÙ„Ø© ${i}</p><p class="text-xs text-yellow-400 font-bold mt-1 bg-yellow-900/40 px-2 rounded">Ø§Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†!</p></div></div><i class="fas fa-chevron-left text-yellow-500 text-3xl opacity-40"></i></div>`;
                else if (isSoon) html += `<div class="glass-card p-5 rounded-2xl flex items-center gap-4 opacity-80 border-l-4 border-l-blue-500"><div class="bg-blue-500/20 text-blue-400 w-12 h-12 rounded-full flex justify-center items-center"><i class="fas fa-clock"></i></div><div><p class="font-bold text-gray-300">Ø§Ù„Ø¬ÙˆÙ„Ø© ${i}</p><p class="text-xs text-blue-400 mt-1">Ù‚Ø±ÙŠØ¨Ø§Ù‹...</p></div></div>`;
                else html += `<div class="glass-card p-5 rounded-2xl flex items-center gap-4 opacity-40 border-l-4 border-l-gray-600"><div class="bg-gray-800 text-gray-500 w-12 h-12 rounded-full flex justify-center items-center"><i class="fas fa-lock"></i></div><p class="font-bold text-sm text-gray-500">Ø§Ù„Ø¬ÙˆÙ„Ø© ${i}</p></div>`;
            }
            container.innerHTML = html;
        }

        window.openQuiz = function(day) {
            document.getElementById('quiz-overlay').style.display = 'flex';
            document.getElementById('quiz-content').innerHTML = '<div class="text-center text-yellow-500 py-10"><i class="fas fa-spinner fa-spin text-6xl mb-6"></i><p class="font-bold">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ø¹Ø¨...</p></div>';
            db.collection("quizzes_pool").doc("day_" + day).get().then(snap => {
                if (snap.exists && snap.data().variations) {
                    qList = snap.data().variations[0].questions; curIdx = 0; curSc = 0; isQuizActive = true; window.showQ();
                } else { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©!"); location.reload(); }
            });
        }

        window.showQ = function() {
            if (curIdx >= qList.length) return window.endQ();
            let q = qList[curIdx];
            document.getElementById('quiz-content').innerHTML = `
                <div class="flex justify-between items-center text-sm font-bold text-gray-400 mb-6 bg-gray-900 p-3 rounded-xl border border-gray-700"><span>Ø³Ø¤Ø§Ù„ ${curIdx+1} / ${qList.length}</span><span id="timer-badge" class="bg-green-900/30 text-green-500 px-4 py-1.5 rounded-lg border border-green-700/50"><i class="fas fa-stopwatch mr-1"></i> <span id="t-txt">20</span>s</span></div>
                <div class="w-full bg-gray-800 h-2.5 rounded-full mb-8 overflow-hidden"><div id="t-bar" class="h-full bg-green-500 w-full"></div></div>
                <h2 class="text-2xl font-black text-center mb-10 text-white">${q.q}</h2>
                <div>${q.options.map((o,i) => `<button onclick="window.ans(${i})" class="opt-btn">${o}</button>`).join('')}</div>`;
            window.startT();
        }

        window.startT = function() {
            let left = 20; clearInterval(timer);
            let bar = document.getElementById('t-bar'), badge = document.getElementById('timer-badge');
            timer = setInterval(() => {
                left--; document.getElementById('t-txt').innerText = left;
                bar.style.width = (left/20*100)+"%";
                if(left <= 5) { bar.style.backgroundColor = "#ef4444"; badge.className = "bg-red-900/30 text-red-500 px-4 py-1.5 rounded-lg border border-red-700/50 danger-pulse"; }
                if(left <= 0) window.ans(-1);
            }, 1000);
        }

        window.ans = function(i) { clearInterval(timer); if(i===qList[curIdx].correctIndex) curSc++; curIdx++; window.showQ(); }

        window.endQ = function() {
            isQuizActive = false;
            document.getElementById('quiz-content').innerHTML = '<div class="text-center text-yellow-500 py-10"><i class="fas fa-cog fa-spin text-6xl mb-6"></i><p class="font-bold">Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª...</p></div>';
            db.collection("users").doc(user.id).update({ score: firebase.firestore.FieldValue.increment(curSc) }).then(() => {
                return db.collection("users").doc(user.id).collection("game_logs").doc("day_"+adminDay).set({ day: adminDay, score: curSc, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            }).then(() => {
                if(typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, zIndex: 9999 });
                document.getElementById('quiz-content').innerHTML = `<div class="text-center pb-4"><div class="inline-block bg-yellow-900/30 p-6 rounded-full mb-6 border-4 border-yellow-500"><i class="fas fa-trophy text-7xl gold-text"></i></div><h2 class="text-3xl font-black text-white mb-2">Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„!</h2><div class="bg-gray-900 border border-gray-700 rounded-3xl p-6 mb-8"><p class="text-xs text-gray-500 font-bold mb-2">Ø­ØµØ¯Øª Ø§Ù„ÙŠÙˆÙ…</p><p class="text-6xl font-black text-yellow-500">${curSc} <span class="text-lg text-gray-500">/ ${qList.length}</span></p></div><button onclick="location.reload()" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-black py-4 rounded-xl text-lg shadow-lg">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button></div>`;
            });
        }

        window.showTab = function(v) {
            document.getElementById('view-arena').classList.toggle('hidden', v!=='arena');
            document.getElementById('view-leaderboard').classList.toggle('hidden', v!=='leaderboard');
            document.getElementById('btn-arena').classList.toggle('active', v==='arena');
            document.getElementById('btn-leader').classList.toggle('active', v==='leaderboard');
            
            if(v==='leaderboard') {
                document.getElementById('group-list').innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-2xl text-yellow-500"></i></div>';
                
                db.collection("users").orderBy("score", "desc").limit(1).get().then(snap => {
                    if(!snap.empty) {
                        let topUser = snap.docs[0].data();
                        document.getElementById('overall-champion').innerHTML = `
                            <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 p-1 rounded-3xl shadow-[0_0_20px_rgba(212,175,55,0.4)] animate-pulse">
                                <div class="bg-gray-900 rounded-[22px] p-5 flex items-center justify-between">
                                    <div class="flex items-center gap-3"><div class="bg-yellow-500/20 text-yellow-500 w-12 h-12 rounded-full flex justify-center items-center text-2xl"><i class="fas fa-crown"></i></div><div><p class="text-[10px] text-yellow-500 font-bold mb-0.5">Ø§Ù„Ø£ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ© ğŸ‘‘</p><p class="font-black text-white text-md">${topUser.name || '---'}</p></div></div><div class="text-center"><span class="font-black text-3xl gold-text">${topUser.score || 0}</span></div>
                                </div>
                            </div>`;
                    }
                });

                db.collection("users").where("group", "==", user.group).get().then(snap => {
                    let m = []; snap.forEach(d => m.push(d.data())); m.sort((a,b)=>(b.score||0)-(a.score||0));
                    let html = '';
                    m.forEach((u, i) => {
                        let rankIcon = i===0 ? '<i class="fas fa-medal text-yellow-400 text-2xl drop-shadow-md"></i>' : i===1 ? '<i class="fas fa-medal text-gray-300 text-xl"></i>' : i===2 ? '<i class="fas fa-medal text-orange-400 text-xl"></i>' : `<span class="text-gray-500 font-bold
