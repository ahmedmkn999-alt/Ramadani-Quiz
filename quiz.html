<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحدي كويز الرمضاني</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #050a15; color: white; background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png'); user-select: none; }
        .quiz-card { background: rgba(13, 27, 42, 0.95); border: 2px solid #b8860b; border-radius: 20px; box-shadow: 0 0 20px rgba(184, 134, 11, 0.2); }
        .option-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(184, 134, 11, 0.2); transition: 0.2s; }
        .option-btn:active { background: #b8860b; }
        .timer-bar { height: 6px; background: #b8860b; transition: width 1s linear; width: 100%; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="loading" class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>جاري تجهيز الملعب..</p></div>
    
    <div id="quiz" class="hidden w-full max-w-lg quiz-card p-6 md:p-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 left-0"><div id="timer-progress" class="timer-bar"></div></div>
        <div class="flex justify-between items-center mb-6 mt-2"><span class="bg-yellow-600 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow" id="q-n">سؤال 1 / 15</span><span class="text-yellow-500 font-bold text-sm bg-gray-900 px-3 py-1 rounded-full border border-yellow-700" id="t-t"><i class="fas fa-clock ml-1"></i>40ث</span></div>
        <h2 id="q-text" class="text-lg md:text-xl font-bold text-center mb-6 leading-relaxed"></h2>
        <div id="opts" class="grid grid-cols-1 gap-3"></div>
    </div>

    <div id="res" class="hidden text-center quiz-card p-10 max-w-sm w-full">
        <div class="w-20 h-20 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-gray-900 shadow-xl"><i class="fas fa-trophy text-4xl text-white"></i></div>
        <h2 class="text-2xl font-bold">عاش يا بطل!</h2>
        <p class="text-xs text-gray-400 mt-2">تم تسجيل نتيجتك بنجاح</p>
        <div class="bg-gray-900 p-4 rounded-2xl my-6 border border-gray-700"><p class="text-[10px] text-gray-400 uppercase font-bold mb-1">نقاطك في الماتش ده</p><p id="f-s" class="text-5xl font-black text-yellow-500">0</p></div>
        <button onclick="location.href='dashboard.html'" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-700 text-white py-4 rounded-xl font-bold shadow-lg"><i class="fas fa-arrow-right ml-2"></i>الرجوع للوحة</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDocs, collection, updateDoc, increment, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBZMnIJ_IOqeAfXqFt-m4tM1Lvo0tUDnk8", projectId: "ramadan-87817", appId: "1:343525703258:web:6776b4857425df8bcca263" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        let qs = [], cur = 0, score = 0, timer, tl = 40; const u = JSON.parse(localStorage.getItem('currentUser'));

        async function init() {
            if(!u) location.href = "index.html";
            // يسحب الكويزات اللي حالتها شغالة بس
            const q = query(collection(db, "quizzes"), where("isActive", "==", true));
            const s = await getDocs(q); const all = []; s.forEach(d => all.push(d.data()));
            if(all.length === 0) { alert("الماتش لسه مبدأش يا حريف!"); location.href = "dashboard.html"; return; }
            qs = all[Math.floor(Math.random()*all.length)].questions;
            document.getElementById('loading').classList.add('hidden'); document.getElementById('quiz').classList.remove('hidden'); show();
        }

        function show() {
            if(cur >= 15 || cur >= qs.length) return finish();
            const q = qs[cur]; document.getElementById('q-n').innerText = `سؤال ${cur+1} / 15`; document.getElementById('q-text').innerText = q.q;
            const g = document.getElementById('opts'); g.innerHTML = '';
            q.options.forEach((o, i) => { const b = document.createElement('button'); b.className = "option-btn w-full p-4 rounded-xl text-right text-sm font-bold shadow"; b.innerText = o; b.onclick = () => handle(i); g.appendChild(b); });
            tl = 40; clearInterval(timer); timer = setInterval(() => { tl--; document.getElementById('t-t').innerHTML = `<i class="fas fa-clock ml-1"></i>${tl}ث`; document.getElementById('timer-progress').style.width = (tl/40)*100+"%"; if(tl<=0) handle(-1); }, 1000);
        }

        function handle(idx) { if(idx === qs[cur].correctIndex) score++; cur++; show(); }

        async function finish() {
            clearInterval(timer); document.getElementById('quiz').classList.add('hidden'); document.getElementById('loading').classList.remove('hidden'); document.getElementById('loading').innerHTML = '<i class="fas fa-spinner fa-spin text-4xl text-yellow-500 mb-4"></i><p>جاري تسجيل النتيجة..</p>';
            await updateDoc(doc(db, "users", u.id), { hasCompletedToday: true, score: increment(score), rounds: increment(1) });
            document.getElementById('loading').classList.add('hidden'); document.getElementById('res').classList.remove('hidden'); document.getElementById('f-s').innerText = score;
        }

        document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'hidden' && cur < 15) finish(); });
        init();
    </script>
</body>
</html>
